THREE.SkinnedMesh=function(e,t,i){THREE.Mesh.call(this,e,t);this.useVertexTexture=void 0!==i?i:!0;this.identityMatrix=new THREE.Matrix4;this.bones=[];this.boneMatrices=[];var r,a,n,o,s,l;if(this.geometry&&void 0!==this.geometry.bones){for(r=0;r<this.geometry.bones.length;r++){n=this.geometry.bones[r];o=n.pos;s=n.rotq;l=n.scl;a=this.addBone();a.name=n.name;a.position.set(o[0],o[1],o[2]);a.quaternion.set(s[0],s[1],s[2],s[3]);if(void 0!==l)a.scale.set(l[0],l[1],l[2]);else a.scale.set(1,1,1)}for(r=0;r<this.bones.length;r++){n=this.geometry.bones[r];a=this.bones[r];if(-1===n.parent)this.add(a);else this.bones[n.parent].add(a)}var h=this.bones.length;if(this.useVertexTexture){var c;if(h>256)c=64;else if(h>64)c=32;else if(h>16)c=16;else c=8;this.boneTextureWidth=c;this.boneTextureHeight=c;this.boneMatrices=new Float32Array(4*this.boneTextureWidth*this.boneTextureHeight);this.boneTexture=new THREE.DataTexture(this.boneMatrices,this.boneTextureWidth,this.boneTextureHeight,THREE.RGBAFormat,THREE.FloatType);this.boneTexture.minFilter=THREE.NearestFilter;this.boneTexture.magFilter=THREE.NearestFilter;this.boneTexture.generateMipmaps=!1;this.boneTexture.flipY=!1}else this.boneMatrices=new Float32Array(16*h);this.pose()}};THREE.SkinnedMesh.prototype=Object.create(THREE.Mesh.prototype);THREE.SkinnedMesh.prototype.addBone=function(e){if(void 0===e)e=new THREE.Bone(this);this.bones.push(e);return e};THREE.SkinnedMesh.prototype.updateMatrixWorld=function(){var e=new THREE.Matrix4;return function(t){this.matrixAutoUpdate&&this.updateMatrix();if(this.matrixWorldNeedsUpdate||t){if(this.parent)this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix);else this.matrixWorld.copy(this.matrix);this.matrixWorldNeedsUpdate=!1;t=!0}for(var i=0,r=this.children.length;r>i;i++){var a=this.children[i];if(a instanceof THREE.Bone)a.update(this.identityMatrix,!1);else a.updateMatrixWorld(!0)}if(void 0==this.boneInverses){this.boneInverses=[];for(var n=0,o=this.bones.length;o>n;n++){var s=new THREE.Matrix4;s.getInverse(this.bones[n].skinMatrix);this.boneInverses.push(s)}}for(var n=0,o=this.bones.length;o>n;n++){e.multiplyMatrices(this.bones[n].skinMatrix,this.boneInverses[n]);e.flattenToArrayOffset(this.boneMatrices,16*n)}if(this.useVertexTexture)this.boneTexture.needsUpdate=!0}}();THREE.SkinnedMesh.prototype.pose=function(){this.updateMatrixWorld(!0);this.normalizeSkinWeights()};THREE.SkinnedMesh.prototype.normalizeSkinWeights=function(){if(this.geometry instanceof THREE.Geometry)for(var e=0;e<this.geometry.skinIndices.length;e++){var t=this.geometry.skinWeights[e];var i=1/t.lengthManhattan();if(1/0!==i)t.multiplyScalar(i);else t.set(1)}else;};THREE.SkinnedMesh.prototype.clone=function(e){if(void 0===e)e=new THREE.SkinnedMesh(this.geometry,this.material,this.useVertexTexture);THREE.Mesh.prototype.clone.call(this,e);return e};