THREE.LensFlarePlugin=function(){function e(e,i){var r=t.createProgram();var a=t.createShader(t.FRAGMENT_SHADER);var o=t.createShader(t.VERTEX_SHADER);var n="precision "+i+" float;\n";t.shaderSource(a,n+e.fragmentShader);t.shaderSource(o,n+e.vertexShader);t.compileShader(a);t.compileShader(o);t.attachShader(r,a);t.attachShader(r,o);t.linkProgram(r);return r}var t,i,r,a={};this.init=function(o){t=o.context;i=o;r=o.getPrecision();a.vertices=new Float32Array(16);a.faces=new Uint16Array(6);var n=0;a.vertices[n++]=-1;a.vertices[n++]=-1;a.vertices[n++]=0;a.vertices[n++]=0;a.vertices[n++]=1;a.vertices[n++]=-1;a.vertices[n++]=1;a.vertices[n++]=0;a.vertices[n++]=1;a.vertices[n++]=1;a.vertices[n++]=1;a.vertices[n++]=1;a.vertices[n++]=-1;a.vertices[n++]=1;a.vertices[n++]=0;a.vertices[n++]=1;n=0;a.faces[n++]=0;a.faces[n++]=1;a.faces[n++]=2;a.faces[n++]=0;a.faces[n++]=2;a.faces[n++]=3;a.vertexBuffer=t.createBuffer();a.elementBuffer=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,a.vertexBuffer);t.bufferData(t.ARRAY_BUFFER,a.vertices,t.STATIC_DRAW);t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.elementBuffer);t.bufferData(t.ELEMENT_ARRAY_BUFFER,a.faces,t.STATIC_DRAW);a.tempTexture=t.createTexture();a.occlusionTexture=t.createTexture();t.bindTexture(t.TEXTURE_2D,a.tempTexture);t.texImage2D(t.TEXTURE_2D,0,t.RGB,16,16,0,t.RGB,t.UNSIGNED_BYTE,null);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST);t.bindTexture(t.TEXTURE_2D,a.occlusionTexture);t.texImage2D(t.TEXTURE_2D,0,t.RGBA,16,16,0,t.RGBA,t.UNSIGNED_BYTE,null);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST);if(t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS)<=0){a.hasVertexTexture=!1;a.program=e(THREE.ShaderFlares["lensFlare"],r)}else{a.hasVertexTexture=!0;a.program=e(THREE.ShaderFlares["lensFlareVertexTexture"],r)}a.attributes={};a.uniforms={};a.attributes.vertex=t.getAttribLocation(a.program,"position");a.attributes.uv=t.getAttribLocation(a.program,"uv");a.uniforms.renderType=t.getUniformLocation(a.program,"renderType");a.uniforms.map=t.getUniformLocation(a.program,"map");a.uniforms.occlusionMap=t.getUniformLocation(a.program,"occlusionMap");a.uniforms.opacity=t.getUniformLocation(a.program,"opacity");a.uniforms.color=t.getUniformLocation(a.program,"color");a.uniforms.scale=t.getUniformLocation(a.program,"scale");a.uniforms.rotation=t.getUniformLocation(a.program,"rotation");a.uniforms.screenPosition=t.getUniformLocation(a.program,"screenPosition")};this.render=function(e,r,o,n){var s=e.__webglFlares,l=s.length;if(l){var c=new THREE.Vector3;var h=n/o,u=.5*o,f=.5*n;var d=16/n,p=new THREE.Vector2(d*h,d);var m=new THREE.Vector3(1,1,0),v=new THREE.Vector2(1,1);var g=a.uniforms,E=a.attributes;t.useProgram(a.program);t.enableVertexAttribArray(a.attributes.vertex);t.enableVertexAttribArray(a.attributes.uv);t.uniform1i(g.occlusionMap,0);t.uniform1i(g.map,1);t.bindBuffer(t.ARRAY_BUFFER,a.vertexBuffer);t.vertexAttribPointer(E.vertex,2,t.FLOAT,!1,16,0);t.vertexAttribPointer(E.uv,2,t.FLOAT,!1,16,8);t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.elementBuffer);t.disable(t.CULL_FACE);t.depthMask(!1);var y,T,x,b,_;for(y=0;l>y;y++){d=16/n;p.set(d*h,d);b=s[y];c.set(b.matrixWorld.elements[12],b.matrixWorld.elements[13],b.matrixWorld.elements[14]);c.applyMatrix4(r.matrixWorldInverse);c.applyProjection(r.projectionMatrix);m.copy(c);v.x=m.x*u+u;v.y=m.y*f+f;if(a.hasVertexTexture||v.x>0&&v.x<o&&v.y>0&&v.y<n){t.activeTexture(t.TEXTURE1);t.bindTexture(t.TEXTURE_2D,a.tempTexture);t.copyTexImage2D(t.TEXTURE_2D,0,t.RGB,v.x-8,v.y-8,16,16,0);t.uniform1i(g.renderType,0);t.uniform2f(g.scale,p.x,p.y);t.uniform3f(g.screenPosition,m.x,m.y,m.z);t.disable(t.BLEND);t.enable(t.DEPTH_TEST);t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,0);t.activeTexture(t.TEXTURE0);t.bindTexture(t.TEXTURE_2D,a.occlusionTexture);t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,v.x-8,v.y-8,16,16,0);t.uniform1i(g.renderType,1);t.disable(t.DEPTH_TEST);t.activeTexture(t.TEXTURE1);t.bindTexture(t.TEXTURE_2D,a.tempTexture);t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,0);b.positionScreen.copy(m);if(b.customUpdateCallback)b.customUpdateCallback(b);else b.updateLensFlares();t.uniform1i(g.renderType,2);t.enable(t.BLEND);for(T=0,x=b.lensFlares.length;x>T;T++){_=b.lensFlares[T];if(_.opacity>.001&&_.scale>.001){m.x=_.x;m.y=_.y;m.z=_.z;d=_.size*_.scale/n;p.x=d*h;p.y=d;t.uniform3f(g.screenPosition,m.x,m.y,m.z);t.uniform2f(g.scale,p.x,p.y);t.uniform1f(g.rotation,_.rotation);t.uniform1f(g.opacity,_.opacity);t.uniform3f(g.color,_.color.r,_.color.g,_.color.b);i.setBlending(_.blending,_.blendEquation,_.blendSrc,_.blendDst);i.setTexture(_.texture,1);t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,0)}}}}t.enable(t.CULL_FACE);t.enable(t.DEPTH_TEST);t.depthMask(!0)}}};