THREE.SpritePlugin=function(){function e(e,t){var r=i.createProgram();var a=i.createShader(i.FRAGMENT_SHADER);var o=i.createShader(i.VERTEX_SHADER);var n="precision "+t+" float;\n";i.shaderSource(a,n+e.fragmentShader);i.shaderSource(o,n+e.vertexShader);i.compileShader(a);i.compileShader(o);i.attachShader(r,a);i.attachShader(r,o);i.linkProgram(r);return r}function t(e,t){if(e.z!==t.z)return t.z-e.z;else return t.id-e.id}var i,r,a,o={};this.init=function(t){i=t.context;r=t;a=t.getPrecision();o.vertices=new Float32Array(16);o.faces=new Uint16Array(6);var n=0;o.vertices[n++]=-1;o.vertices[n++]=-1;o.vertices[n++]=0;o.vertices[n++]=0;o.vertices[n++]=1;o.vertices[n++]=-1;o.vertices[n++]=1;o.vertices[n++]=0;o.vertices[n++]=1;o.vertices[n++]=1;o.vertices[n++]=1;o.vertices[n++]=1;o.vertices[n++]=-1;o.vertices[n++]=1;o.vertices[n++]=0;o.vertices[n++]=1;n=0;o.faces[n++]=0;o.faces[n++]=1;o.faces[n++]=2;o.faces[n++]=0;o.faces[n++]=2;o.faces[n++]=3;o.vertexBuffer=i.createBuffer();o.elementBuffer=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,o.vertexBuffer);i.bufferData(i.ARRAY_BUFFER,o.vertices,i.STATIC_DRAW);i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,o.elementBuffer);i.bufferData(i.ELEMENT_ARRAY_BUFFER,o.faces,i.STATIC_DRAW);o.program=e(THREE.ShaderSprite["sprite"],a);o.attributes={};o.uniforms={};o.attributes.position=i.getAttribLocation(o.program,"position");o.attributes.uv=i.getAttribLocation(o.program,"uv");o.uniforms.uvOffset=i.getUniformLocation(o.program,"uvOffset");o.uniforms.uvScale=i.getUniformLocation(o.program,"uvScale");o.uniforms.rotation=i.getUniformLocation(o.program,"rotation");o.uniforms.scale=i.getUniformLocation(o.program,"scale");o.uniforms.alignment=i.getUniformLocation(o.program,"alignment");o.uniforms.color=i.getUniformLocation(o.program,"color");o.uniforms.map=i.getUniformLocation(o.program,"map");o.uniforms.opacity=i.getUniformLocation(o.program,"opacity");o.uniforms.useScreenCoordinates=i.getUniformLocation(o.program,"useScreenCoordinates");o.uniforms.sizeAttenuation=i.getUniformLocation(o.program,"sizeAttenuation");o.uniforms.screenPosition=i.getUniformLocation(o.program,"screenPosition");o.uniforms.modelViewMatrix=i.getUniformLocation(o.program,"modelViewMatrix");o.uniforms.projectionMatrix=i.getUniformLocation(o.program,"projectionMatrix");o.uniforms.fogType=i.getUniformLocation(o.program,"fogType");o.uniforms.fogDensity=i.getUniformLocation(o.program,"fogDensity");o.uniforms.fogNear=i.getUniformLocation(o.program,"fogNear");o.uniforms.fogFar=i.getUniformLocation(o.program,"fogFar");o.uniforms.fogColor=i.getUniformLocation(o.program,"fogColor");o.uniforms.alphaTest=i.getUniformLocation(o.program,"alphaTest")};this.render=function(e,a,n,s){var l=e.__webglSprites,c=l.length;if(c){var h=o.attributes,u=o.uniforms;var f=s/n;var d=.5*n,p=.5*s;i.useProgram(o.program);i.enableVertexAttribArray(h.position);i.enableVertexAttribArray(h.uv);i.disable(i.CULL_FACE);i.enable(i.BLEND);i.bindBuffer(i.ARRAY_BUFFER,o.vertexBuffer);i.vertexAttribPointer(h.position,2,i.FLOAT,!1,16,0);i.vertexAttribPointer(h.uv,2,i.FLOAT,!1,16,8);i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,o.elementBuffer);i.uniformMatrix4fv(u.projectionMatrix,!1,a.projectionMatrix.elements);i.activeTexture(i.TEXTURE0);i.uniform1i(u.map,0);var m=0;var v=0;var g=e.fog;if(g){i.uniform3f(u.fogColor,g.color.r,g.color.g,g.color.b);if(g instanceof THREE.Fog){i.uniform1f(u.fogNear,g.near);i.uniform1f(u.fogFar,g.far);i.uniform1i(u.fogType,1);m=1;v=1}else if(g instanceof THREE.FogExp2){i.uniform1f(u.fogDensity,g.density);i.uniform1i(u.fogType,2);m=2;v=2}}else{i.uniform1i(u.fogType,0);m=0;v=0}var E,y,T,x,b,_=[];for(E=0;c>E;E++){y=l[E];T=y.material;if(y.visible&&0!==T.opacity)if(!T.useScreenCoordinates){y._modelViewMatrix.multiplyMatrices(a.matrixWorldInverse,y.matrixWorld);y.z=-y._modelViewMatrix.elements[14]}else y.z=-y.position.z;else;}l.sort(t);for(E=0;c>E;E++){y=l[E];T=y.material;if(y.visible&&0!==T.opacity){if(T.map&&T.map.image&&T.map.image.width){i.uniform1f(u.alphaTest,T.alphaTest);if(T.useScreenCoordinates===!0){i.uniform1i(u.useScreenCoordinates,1);i.uniform3f(u.screenPosition,(y.position.x*r.devicePixelRatio-d)/d,(p-y.position.y*r.devicePixelRatio)/p,Math.max(0,Math.min(1,y.position.z)));_[0]=r.devicePixelRatio;_[1]=r.devicePixelRatio}else{i.uniform1i(u.useScreenCoordinates,0);i.uniform1i(u.sizeAttenuation,T.sizeAttenuation?1:0);i.uniformMatrix4fv(u.modelViewMatrix,!1,y._modelViewMatrix.elements);_[0]=1;_[1]=1}if(e.fog&&T.fog)b=v;else b=0;if(m!==b){i.uniform1i(u.fogType,b);m=b}x=1/(T.scaleByViewport?s:1);_[0]*=x*f*y.scale.x;_[1]*=x*y.scale.y;i.uniform2f(u.uvScale,T.uvScale.x,T.uvScale.y);i.uniform2f(u.uvOffset,T.uvOffset.x,T.uvOffset.y);i.uniform2f(u.alignment,T.alignment.x,T.alignment.y);i.uniform1f(u.opacity,T.opacity);i.uniform3f(u.color,T.color.r,T.color.g,T.color.b);i.uniform1f(u.rotation,y.rotation);i.uniform2fv(u.scale,_);r.setBlending(T.blending,T.blendEquation,T.blendSrc,T.blendDst);r.setDepthTest(T.depthTest);r.setDepthWrite(T.depthWrite);r.setTexture(T.map,0);i.drawElements(i.TRIANGLES,6,i.UNSIGNED_SHORT,0)}}else;}i.enable(i.CULL_FACE)}}};