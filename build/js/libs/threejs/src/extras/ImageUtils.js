THREE.ImageUtils={crossOrigin:"anonymous",loadTexture:function(e,t,i){var r=new Image,n=new THREE.Texture(r,t),o=new THREE.ImageLoader;return o.crossOrigin=this.crossOrigin,o.load(e,function(e){n.image=e,n.needsUpdate=!0,i&&i(n)}),n.sourceFile=e,n},loadCompressedTexture:function(e,t,i,r){var n=new THREE.CompressedTexture;n.mapping=t;var o=new XMLHttpRequest;return o.onload=function(){var e=o.response,t=THREE.ImageUtils.parseDDS(e,!0);n.format=t.format,n.mipmaps=t.mipmaps,n.image.width=t.width,n.image.height=t.height,n.generateMipmaps=!1,n.needsUpdate=!0,i&&i(n)},o.onerror=r,o.open("GET",e,!0),o.responseType="arraybuffer",o.send(null),n},loadTextureCube:function(e,t,i,r){var n=[];n.loadCount=0;var o=new THREE.Texture;o.image=n,void 0!==t&&(o.mapping=t),o.flipY=!1;for(var a=0,s=e.length;s>a;++a){var l=new Image;n[a]=l,l.onload=function(){n.loadCount+=1,6===n.loadCount&&(o.needsUpdate=!0,i&&i(o))},l.onerror=r,l.crossOrigin=this.crossOrigin,l.src=e[a]}return o},loadCompressedTextureCube:function(e,t,i,r){var n=[];n.loadCount=0;var o=new THREE.CompressedTexture;o.image=n,void 0!==t&&(o.mapping=t),o.flipY=!1,o.generateMipmaps=!1;var a=function(e,t){return function(){var r=e.response,a=THREE.ImageUtils.parseDDS(r,!0);t.format=a.format,t.mipmaps=a.mipmaps,t.width=a.width,t.height=a.height,n.loadCount+=1,6===n.loadCount&&(o.format=a.format,o.needsUpdate=!0,i&&i(o))}};if(e instanceof Array)for(var s=0,l=e.length;l>s;++s){var c={};n[s]=c;var h=new XMLHttpRequest;h.onload=a(h,c),h.onerror=r;var u=e[s];h.open("GET",u,!0),h.responseType="arraybuffer",h.send(null)}else{var u=e,h=new XMLHttpRequest;h.onload=function(){var e=h.response,t=THREE.ImageUtils.parseDDS(e,!0);if(t.isCubemap){for(var r=t.mipmaps.length/t.mipmapCount,a=0;r>a;a++){n[a]={mipmaps:[]};for(var s=0;s<t.mipmapCount;s++)n[a].mipmaps.push(t.mipmaps[a*t.mipmapCount+s]),n[a].format=t.format,n[a].width=t.width,n[a].height=t.height}o.format=t.format,o.needsUpdate=!0,i&&i(o)}},h.onerror=r,h.open("GET",u,!0),h.responseType="arraybuffer",h.send(null)}return o},parseDDS:function(e,t){function i(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function r(e){return String.fromCharCode(255&e,255&e>>8,255&e>>16,255&e>>24)}var n={mipmaps:[],width:0,height:0,format:null,mipmapCount:1},o=542327876,a=131072,s=512,l=4,c=i("DXT1"),h=i("DXT3"),u=i("DXT5"),d=31,p=0,f=1,m=2,v=3,g=4,E=7,y=20,T=21,_=28,b=new Int32Array(e,0,d);if(b[p]!==o)return console.error("ImageUtils.parseDDS(): Invalid magic number in DDS header"),n;if(!b[y]&l)return console.error("ImageUtils.parseDDS(): Unsupported format, must contain a FourCC code"),n;var x,R=b[T];switch(R){case c:x=8,n.format=THREE.RGB_S3TC_DXT1_Format;break;case h:x=16,n.format=THREE.RGBA_S3TC_DXT3_Format;break;case u:x=16,n.format=THREE.RGBA_S3TC_DXT5_Format;break;default:return console.error("ImageUtils.parseDDS(): Unsupported FourCC code: ",r(R)),n}n.mipmapCount=1,b[m]&a&&t!==!1&&(n.mipmapCount=Math.max(1,b[E])),n.isCubemap=b[_]&s?!0:!1,n.width=b[g],n.height=b[v];for(var w=b[f]+4,H=n.width,S=n.height,M=n.isCubemap?6:1,C=0;M>C;C++){for(var A=0;A<n.mipmapCount;A++){var D=Math.max(4,H)/4*Math.max(4,S)/4*x,P=new Uint8Array(e,w,D),L={data:P,width:H,height:S};n.mipmaps.push(L),w+=D,H=Math.max(.5*H,1),S=Math.max(.5*S,1)}H=n.width,S=n.height}return n},getNormalMap:function(e,t){var i=function(e,t){return[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]]},r=function(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]},n=function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return[e[0]/t,e[1]/t,e[2]/t]};t=1|t;var o=e.width,a=e.height,s=document.createElement("canvas");s.width=o,s.height=a;var l=s.getContext("2d");l.drawImage(e,0,0);for(var c=l.getImageData(0,0,o,a).data,h=l.createImageData(o,a),u=h.data,d=0;o>d;d++)for(var p=0;a>p;p++){var f=0>p-1?0:p-1,m=p+1>a-1?a-1:p+1,v=0>d-1?0:d-1,g=d+1>o-1?o-1:d+1,E=[],y=[0,0,c[4*(p*o+d)]/255*t];E.push([-1,0,c[4*(p*o+v)]/255*t]),E.push([-1,-1,c[4*(f*o+v)]/255*t]),E.push([0,-1,c[4*(f*o+d)]/255*t]),E.push([1,-1,c[4*(f*o+g)]/255*t]),E.push([1,0,c[4*(p*o+g)]/255*t]),E.push([1,1,c[4*(m*o+g)]/255*t]),E.push([0,1,c[4*(m*o+d)]/255*t]),E.push([-1,1,c[4*(m*o+v)]/255*t]);for(var T=[],_=E.length,b=0;_>b;b++){var x=E[b],R=E[(b+1)%_];x=r(x,y),R=r(R,y),T.push(n(i(x,R)))}for(var w=[0,0,0],b=0;b<T.length;b++)w[0]+=T[b][0],w[1]+=T[b][1],w[2]+=T[b][2];w[0]/=T.length,w[1]/=T.length,w[2]/=T.length;var H=4*(p*o+d);u[H]=0|255*((w[0]+1)/2),u[H+1]=0|255*((w[1]+1)/2),u[H+2]=0|255*w[2],u[H+3]=255}return l.putImageData(h,0,0),s},generateDataTexture:function(e,t,i){for(var r=e*t,n=new Uint8Array(3*r),o=Math.floor(255*i.r),a=Math.floor(255*i.g),s=Math.floor(255*i.b),l=0;r>l;l++)n[3*l]=o,n[3*l+1]=a,n[3*l+2]=s;var c=new THREE.DataTexture(n,e,t,THREE.RGBFormat);return c.needsUpdate=!0,c}};