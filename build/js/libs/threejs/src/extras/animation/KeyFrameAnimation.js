THREE.KeyFrameAnimation=function(e,t,i){this.root=e,this.data=THREE.AnimationHandler.get(t),this.hierarchy=THREE.AnimationHandler.parse(e),this.currentTime=0,this.timeScale=.001,this.isPlaying=!1,this.isPaused=!0,this.loop=!0,this.JITCompile=void 0!==i?i:!0;for(var r=0,n=this.hierarchy.length;n>r;r++){var o=this.data.hierarchy[r].keys,a=this.data.hierarchy[r].sids,s=this.hierarchy[r];if(o.length&&a){for(var l=0;l<a.length;l++){var c=a[l],h=this.getNextKeyWith(c,r,0);h&&h.apply(c)}s.matrixAutoUpdate=!1,this.data.hierarchy[r].node.updateMatrix(),s.matrixWorldNeedsUpdate=!0}}},THREE.KeyFrameAnimation.prototype.play=function(e,t){if(!this.isPlaying){this.isPlaying=!0,this.loop=void 0!==e?e:!0,this.currentTime=void 0!==t?t:0,this.startTimeMs=t,this.startTime=1e7,this.endTime=-this.startTime;var i,r,n,o=this.hierarchy.length;for(i=0;o>i;i++){r=this.hierarchy[i],n=this.data.hierarchy[i],void 0===n.animationCache&&(n.animationCache={},n.animationCache.prevKey=null,n.animationCache.nextKey=null,n.animationCache.originalMatrix=r instanceof THREE.Bone?r.skinMatrix:r.matrix);var a=this.data.hierarchy[i].keys;a.length&&(n.animationCache.prevKey=a[0],n.animationCache.nextKey=a[1],this.startTime=Math.min(a[0].time,this.startTime),this.endTime=Math.max(a[a.length-1].time,this.endTime))}this.update(0)}this.isPaused=!1,THREE.AnimationHandler.addToUpdate(this)},THREE.KeyFrameAnimation.prototype.pause=function(){this.isPaused?THREE.AnimationHandler.addToUpdate(this):THREE.AnimationHandler.removeFromUpdate(this),this.isPaused=!this.isPaused},THREE.KeyFrameAnimation.prototype.stop=function(){this.isPlaying=!1,this.isPaused=!1,THREE.AnimationHandler.removeFromUpdate(this);for(var e=0;e<this.data.hierarchy.length;e++){var t=this.hierarchy[e],i=this.data.hierarchy[e];if(void 0!==i.animationCache){var r=i.animationCache.originalMatrix;t instanceof THREE.Bone?(r.copy(t.skinMatrix),t.skinMatrix=r):(r.copy(t.matrix),t.matrix=r),delete i.animationCache}}},THREE.KeyFrameAnimation.prototype.update=function(e){if(this.isPlaying){var t,i,r,n,o,a,s,l,c=this.data.JIT.hierarchy;if(this.currentTime+=e*this.timeScale,s=this.currentTime,a=this.currentTime=this.currentTime%this.data.length,a<this.startTimeMs&&(a=this.currentTime=this.startTimeMs+a),o=parseInt(Math.min(a*this.data.fps,this.data.length*this.data.fps),10),l=s>a,l&&!this.loop){for(var h=0,u=this.hierarchy.length;u>h;h++){var d=this.data.hierarchy[h].keys,p=this.data.hierarchy[h].sids,f=d.length-1,m=this.hierarchy[h];if(d.length){for(var v=0;v<p.length;v++){var g=p[v],E=this.getPrevKeyWith(g,h,f);E&&E.apply(g)}this.data.hierarchy[h].node.updateMatrix(),m.matrixWorldNeedsUpdate=!0}}return this.stop(),void 0}if(!(a<this.startTime)){for(var h=0,u=this.hierarchy.length;u>h;h++){r=this.hierarchy[h],n=this.data.hierarchy[h];var d=n.keys,y=n.animationCache;if(this.JITCompile&&void 0!==c[h][o])r instanceof THREE.Bone?(r.skinMatrix=c[h][o],r.matrixWorldNeedsUpdate=!1):(r.matrix=c[h][o],r.matrixWorldNeedsUpdate=!0);else if(d.length){if(this.JITCompile&&y&&(r instanceof THREE.Bone?r.skinMatrix=y.originalMatrix:r.matrix=y.originalMatrix),t=y.prevKey,i=y.nextKey,t&&i){if(i.time<=s){if(l&&this.loop)for(t=d[0],i=d[1];i.time<a;)t=i,i=d[t.index+1];else if(!l)for(var T=d.length-1;i.time<a&&i.index!==T;)t=i,i=d[t.index+1];y.prevKey=t,y.nextKey=i}i.time>=a?t.interpolate(i,a):t.interpolate(i,i.time)}this.data.hierarchy[h].node.updateMatrix(),r.matrixWorldNeedsUpdate=!0}}if(this.JITCompile&&void 0===c[0][o]){this.hierarchy[0].updateMatrixWorld(!0);for(var h=0;h<this.hierarchy.length;h++)c[h][o]=this.hierarchy[h]instanceof THREE.Bone?this.hierarchy[h].skinMatrix.clone():this.hierarchy[h].matrix.clone()}}}},THREE.KeyFrameAnimation.prototype.getNextKeyWith=function(e,t,i){var r=this.data.hierarchy[t].keys;for(i%=r.length;i<r.length;i++)if(r[i].hasTarget(e))return r[i];return r[0]},THREE.KeyFrameAnimation.prototype.getPrevKeyWith=function(e,t,i){var r=this.data.hierarchy[t].keys;for(i=i>=0?i:i+r.length;i>=0;i--)if(r[i].hasTarget(e))return r[i];return r[r.length-1]};