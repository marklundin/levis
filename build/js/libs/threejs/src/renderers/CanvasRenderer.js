THREE.CanvasRenderer=function(e){function t(){Vt.setRGB(0,0,0);Ut.setRGB(0,0,0);Bt.setRGB(0,0,0);for(var e=0,t=H.length;t>e;e++){var i=H[e];var r=i.color;if(i instanceof THREE.AmbientLight)Vt.add(r);else if(i instanceof THREE.DirectionalLight)Ut.add(r);else if(i instanceof THREE.PointLight)Bt.add(r)}}function i(e,t,i){for(var r=0,a=H.length;a>r;r++){var n=H[r];Nt.copy(n.color);if(n instanceof THREE.DirectionalLight){var o=jt.getPositionFromMatrix(n.matrixWorld).normalize();var s=t.dot(o);if(0>=s)continue;s*=n.intensity;i.add(Nt.multiplyScalar(s))}else if(n instanceof THREE.PointLight){var o=jt.getPositionFromMatrix(n.matrixWorld);var s=t.dot(jt.subVectors(o,e).normalize());if(0>=s)continue;s*=0==n.distance?1:1-Math.min(e.distanceTo(o)/n.distance,1);if(0==s)continue;s*=n.intensity;i.add(Nt.multiplyScalar(s))}}}function r(e,t,i){m(i.opacity);v(i.blending);var r,a,n,o,s,l,c;if(i instanceof THREE.ParticleBasicMaterial)if(null===i.map){n=t.object.scale.x;o=t.object.scale.y;n*=t.scale.x*C;o*=t.scale.y*A;It.min.set(e.x-n,e.y-o);It.max.set(e.x+n,e.y+o);if(zt.isIntersectionBox(It)===!1){It.makeEmpty();return}x(i.color.getStyle());dt.save();dt.translate(e.x,e.y);dt.rotate(-t.rotation);dt.scale(n,o);dt.fillRect(-1,-1,2,2);dt.restore()}else{s=i.map.image;l=s.width>>1;c=s.height>>1;n=t.scale.x*C;o=t.scale.y*A;r=n*l;a=o*c;It.min.set(e.x-r,e.y-a);It.max.set(e.x+r,e.y+a);if(zt.isIntersectionBox(It)===!1){It.makeEmpty();return}dt.save();dt.translate(e.x,e.y);dt.rotate(-t.rotation);dt.scale(n,-o);dt.translate(-l,-c);dt.drawImage(s,0,0);dt.restore()}else if(i instanceof THREE.ParticleCanvasMaterial){r=t.scale.x*C;a=t.scale.y*A;It.min.set(e.x-r,e.y-a);It.max.set(e.x+r,e.y+a);if(zt.isIntersectionBox(It)===!1){It.makeEmpty();return}T(i.color.getStyle());x(i.color.getStyle());dt.save();dt.translate(e.x,e.y);dt.rotate(-t.rotation);dt.scale(r,a);i.program(dt);dt.restore()}}function a(e,t,i,r){m(r.opacity);v(r.blending);dt.beginPath();dt.moveTo(e.positionScreen.x,e.positionScreen.y);dt.lineTo(t.positionScreen.x,t.positionScreen.y);if(r instanceof THREE.LineBasicMaterial){g(r.linewidth);E(r.linecap);y(r.linejoin);if(r.vertexColors!==THREE.VertexColors)T(r.color.getStyle());else{var a=i.vertexColors[0].getStyle();var n=i.vertexColors[1].getStyle();if(a===n)T(a);else{try{var o=dt.createLinearGradient(e.positionScreen.x,e.positionScreen.y,t.positionScreen.x,t.positionScreen.y);o.addColorStop(0,a);o.addColorStop(1,n)}catch(s){o=a}T(o)}}dt.stroke();It.expandByScalar(2*r.linewidth)}else if(r instanceof THREE.LineDashedMaterial){g(r.linewidth);E(r.linecap);y(r.linejoin);T(r.color.getStyle());R(r.dashSize,r.gapSize);dt.stroke();It.expandByScalar(2*r.linewidth);R(null,null)}}function n(e,t,r,a,n,o,l,p){ht.info.render.vertices+=3;ht.info.render.faces++;m(p.opacity);v(p.blending);k=e.positionScreen.x;z=e.positionScreen.y;O=t.positionScreen.x;I=t.positionScreen.y;V=r.positionScreen.x;U=r.positionScreen.y;s(k,z,O,I,V,U);if((p instanceof THREE.MeshLambertMaterial||p instanceof THREE.MeshPhongMaterial)&&null===p.map){Pt.copy(p.color);Lt.copy(p.emissive);if(p.vertexColors===THREE.FaceColors)Pt.multiply(l.color);if(p.wireframe===!1&&p.shading==THREE.SmoothShading&&3==l.vertexNormalsLength){St.copy(Vt);Ct.copy(Vt);At.copy(Vt);i(l.v1.positionWorld,l.vertexNormalsModel[0],St);i(l.v2.positionWorld,l.vertexNormalsModel[1],Ct);i(l.v3.positionWorld,l.vertexNormalsModel[2],At);St.multiply(Pt).add(Lt);Ct.multiply(Pt).add(Lt);At.multiply(Pt).add(Lt);Dt.addColors(Ct,At).multiplyScalar(.5);Z=d(St,Ct,At,Dt);f(k,z,O,I,V,U,0,0,1,0,0,1,Z)}else{Mt.copy(Vt);i(l.centroidModel,l.normalModel,Mt);Mt.multiply(Pt).add(Lt);p.wireframe===!0?c(Mt,p.wireframeLinewidth,p.wireframeLinecap,p.wireframeLinejoin):h(Mt)}}else if(p instanceof THREE.MeshBasicMaterial||p instanceof THREE.MeshLambertMaterial||p instanceof THREE.MeshPhongMaterial)if(null!==p.map){if(p.map.mapping instanceof THREE.UVMapping){Q=l.uvs[0];u(k,z,O,I,V,U,Q[a].x,Q[a].y,Q[n].x,Q[n].y,Q[o].x,Q[o].y,p.map)}}else if(null!==p.envMap){if(p.envMap.mapping instanceof THREE.SphericalReflectionMapping){jt.copy(l.vertexNormalsModelView[a]);$=.5*jt.x+.5;J=.5*jt.y+.5;jt.copy(l.vertexNormalsModelView[n]);et=.5*jt.x+.5;tt=.5*jt.y+.5;jt.copy(l.vertexNormalsModelView[o]);it=.5*jt.x+.5;rt=.5*jt.y+.5;u(k,z,O,I,V,U,$,J,et,tt,it,rt,p.envMap)}}else{Mt.copy(p.color);if(p.vertexColors===THREE.FaceColors)Mt.multiply(l.color);p.wireframe===!0?c(Mt,p.wireframeLinewidth,p.wireframeLinecap,p.wireframeLinejoin):h(Mt)}else if(p instanceof THREE.MeshDepthMaterial){Y=D.near;K=D.far;St.r=St.g=St.b=1-b(e.positionScreen.z*e.positionScreen.w,Y,K);Ct.r=Ct.g=Ct.b=1-b(t.positionScreen.z*t.positionScreen.w,Y,K);At.r=At.g=At.b=1-b(r.positionScreen.z*r.positionScreen.w,Y,K);Dt.addColors(Ct,At).multiplyScalar(.5);Z=d(St,Ct,At,Dt);f(k,z,O,I,V,U,0,0,1,0,0,1,Z)}else if(p instanceof THREE.MeshNormalMaterial){var g;if(p.shading==THREE.FlatShading){g=l.normalModelView;Mt.setRGB(g.x,g.y,g.z).multiplyScalar(.5).addScalar(.5);p.wireframe===!0?c(Mt,p.wireframeLinewidth,p.wireframeLinecap,p.wireframeLinejoin):h(Mt)}else if(p.shading==THREE.SmoothShading){g=l.vertexNormalsModelView[a];St.setRGB(g.x,g.y,g.z).multiplyScalar(.5).addScalar(.5);g=l.vertexNormalsModelView[n];Ct.setRGB(g.x,g.y,g.z).multiplyScalar(.5).addScalar(.5);g=l.vertexNormalsModelView[o];At.setRGB(g.x,g.y,g.z).multiplyScalar(.5).addScalar(.5);Dt.addColors(Ct,At).multiplyScalar(.5);Z=d(St,Ct,At,Dt);f(k,z,O,I,V,U,0,0,1,0,0,1,Z)}}}function o(e,t,r,a,o,u,p,g){ht.info.render.vertices+=4;ht.info.render.faces++;m(g.opacity);v(g.blending);if(!(void 0!==g.map&&null!==g.map||void 0!==g.envMap&&null!==g.envMap)){k=e.positionScreen.x;z=e.positionScreen.y;O=t.positionScreen.x;I=t.positionScreen.y;V=r.positionScreen.x;U=r.positionScreen.y;B=a.positionScreen.x;j=a.positionScreen.y;G=o.positionScreen.x;W=o.positionScreen.y;X=u.positionScreen.x;q=u.positionScreen.y;if(g instanceof THREE.MeshLambertMaterial||g instanceof THREE.MeshPhongMaterial){Pt.copy(g.color);Lt.copy(g.emissive);if(g.vertexColors===THREE.FaceColors)Pt.multiply(p.color);if(g.wireframe===!1&&g.shading==THREE.SmoothShading&&4==p.vertexNormalsLength){St.copy(Vt);Ct.copy(Vt);At.copy(Vt);Dt.copy(Vt);i(p.v1.positionWorld,p.vertexNormalsModel[0],St);i(p.v2.positionWorld,p.vertexNormalsModel[1],Ct);i(p.v4.positionWorld,p.vertexNormalsModel[3],At);i(p.v3.positionWorld,p.vertexNormalsModel[2],Dt);St.multiply(Pt).add(Lt);Ct.multiply(Pt).add(Lt);At.multiply(Pt).add(Lt);Dt.multiply(Pt).add(Lt);Z=d(St,Ct,At,Dt);s(k,z,O,I,B,j);f(k,z,O,I,B,j,0,0,1,0,0,1,Z);s(G,W,V,U,X,q);f(G,W,V,U,X,q,1,0,1,1,0,1,Z)}else{Mt.copy(Vt);i(p.centroidModel,p.normalModel,Mt);Mt.multiply(Pt).add(Lt);l(k,z,O,I,V,U,B,j);g.wireframe===!0?c(Mt,g.wireframeLinewidth,g.wireframeLinecap,g.wireframeLinejoin):h(Mt)}}else if(g instanceof THREE.MeshBasicMaterial){Mt.copy(g.color);if(g.vertexColors===THREE.FaceColors)Mt.multiply(p.color);l(k,z,O,I,V,U,B,j);g.wireframe===!0?c(Mt,g.wireframeLinewidth,g.wireframeLinecap,g.wireframeLinejoin):h(Mt)}else if(g instanceof THREE.MeshNormalMaterial){var E;if(g.shading==THREE.FlatShading){E=p.normalModelView;Mt.setRGB(E.x,E.y,E.z).multiplyScalar(.5).addScalar(.5);l(k,z,O,I,V,U,B,j);g.wireframe===!0?c(Mt,g.wireframeLinewidth,g.wireframeLinecap,g.wireframeLinejoin):h(Mt)}else if(g.shading==THREE.SmoothShading){E=p.vertexNormalsModelView[0];St.setRGB(E.x,E.y,E.z).multiplyScalar(.5).addScalar(.5);E=p.vertexNormalsModelView[1];Ct.setRGB(E.x,E.y,E.z).multiplyScalar(.5).addScalar(.5);E=p.vertexNormalsModelView[3];At.setRGB(E.x,E.y,E.z).multiplyScalar(.5).addScalar(.5);E=p.vertexNormalsModelView[2];Dt.setRGB(E.x,E.y,E.z).multiplyScalar(.5).addScalar(.5);Z=d(St,Ct,At,Dt);s(k,z,O,I,B,j);f(k,z,O,I,B,j,0,0,1,0,0,1,Z);s(G,W,V,U,X,q);f(G,W,V,U,X,q,1,0,1,1,0,1,Z)}}else if(g instanceof THREE.MeshDepthMaterial){Y=D.near;K=D.far;St.r=St.g=St.b=1-b(e.positionScreen.z*e.positionScreen.w,Y,K);Ct.r=Ct.g=Ct.b=1-b(t.positionScreen.z*t.positionScreen.w,Y,K);At.r=At.g=At.b=1-b(a.positionScreen.z*a.positionScreen.w,Y,K);Dt.r=Dt.g=Dt.b=1-b(r.positionScreen.z*r.positionScreen.w,Y,K);Z=d(St,Ct,At,Dt);s(k,z,O,I,B,j);f(k,z,O,I,B,j,0,0,1,0,0,1,Z);s(G,W,V,U,X,q);f(G,W,V,U,X,q,1,0,1,1,0,1,Z)}}else{n(e,t,a,0,1,3,p,g);n(o,r,u,1,2,3,p,g)}}function s(e,t,i,r,a,n){dt.beginPath();dt.moveTo(e,t);dt.lineTo(i,r);dt.lineTo(a,n);dt.closePath()}function l(e,t,i,r,a,n,o,s){dt.beginPath();dt.moveTo(e,t);dt.lineTo(i,r);dt.lineTo(a,n);dt.lineTo(o,s);dt.closePath()}function c(e,t,i,r){g(t);E(i);y(r);T(e.getStyle());dt.stroke();It.expandByScalar(2*t)}function h(e){x(e.getStyle());dt.fill()}function u(e,t,i,r,a,n,o,s,l,c,u,f,d){if(!(d instanceof THREE.DataTexture||void 0===d.image||0==d.image.width)){if(d.needsUpdate===!0){var p=d.wrapS==THREE.RepeatWrapping;var m=d.wrapT==THREE.RepeatWrapping;Ft[d.id]=dt.createPattern(d.image,p===!0&&m===!0?"repeat":p===!0&&m===!1?"repeat-x":p===!1&&m===!0?"repeat-y":"no-repeat");d.needsUpdate=!1}void 0===Ft[d.id]?x("rgba(0,0,0,1)"):x(Ft[d.id]);var v,g,E,y,T,R,b,_,w=d.offset.x/d.repeat.x,H=d.offset.y/d.repeat.y,M=d.image.width*d.repeat.x,S=d.image.height*d.repeat.y;o=(o+w)*M;s=(1-s+H)*S;l=(l+w)*M;c=(1-c+H)*S;u=(u+w)*M;f=(1-f+H)*S;i-=e;r-=t;a-=e;n-=t;l-=o;c-=s;u-=o;f-=s;b=l*f-u*c;if(0!==b){_=1/b;v=(f*i-c*a)*_;g=(f*r-c*n)*_;E=(l*a-u*i)*_;y=(l*n-u*r)*_;T=e-v*o-E*s;R=t-g*o-y*s;dt.save();dt.transform(v,g,E,y,T,R);dt.fill();dt.restore()}else{if(void 0===kt[d.id]){var C=document.createElement("canvas");C.width=d.image.width;C.height=d.image.height;var A=C.getContext("2d");A.drawImage(d.image,0,0);kt[d.id]=A.getImageData(0,0,d.image.width,d.image.height).data}var D=kt[d.id];var P=4*(Math.floor(o)+Math.floor(s)*d.image.width);Mt.setRGB(D[P]/255,D[P+1]/255,D[P+2]/255);h(Mt)}}}function f(e,t,i,r,a,n,o,s,l,c,h,u,f){var d,p,m,v,g,E,y,T,x=f.width-1,R=f.height-1;o*=x;s*=R;l*=x;c*=R;h*=x;u*=R;i-=e;r-=t;a-=e;n-=t;l-=o;c-=s;h-=o;u-=s;y=l*u-h*c;T=1/y;d=(u*i-c*a)*T;p=(u*r-c*n)*T;m=(l*a-h*i)*T;v=(l*n-h*r)*T;g=e-d*o-m*s;E=t-p*o-v*s;dt.save();dt.transform(d,p,m,v,g,E);dt.clip();dt.drawImage(f,0,0);dt.restore()}function d(e,t,i,r){st[0]=0|255*e.r;st[1]=0|255*e.g;st[2]=0|255*e.b;st[4]=0|255*t.r;st[5]=0|255*t.g;st[6]=0|255*t.b;st[8]=0|255*i.r;st[9]=0|255*i.g;st[10]=0|255*i.b;st[12]=0|255*r.r;st[13]=0|255*r.g;st[14]=0|255*r.b;nt.putImageData(ot,0,0);ct.drawImage(at,0,0);return lt}function p(e,t,i){var r,a=t.x-e.x,n=t.y-e.y,o=a*a+n*n;if(0!==o){r=i/Math.sqrt(o);a*=r;n*=r;t.x+=a;t.y+=n;e.x-=a;e.y-=n}}function m(e){if(vt!==e){dt.globalAlpha=e;vt=e}}function v(e){if(gt!==e){if(e===THREE.NormalBlending)dt.globalCompositeOperation="source-over";else if(e===THREE.AdditiveBlending)dt.globalCompositeOperation="lighter";else if(e===THREE.SubtractiveBlending)dt.globalCompositeOperation="darker";gt=e}}function g(e){if(Tt!==e){dt.lineWidth=e;Tt=e}}function E(e){if(xt!==e){dt.lineCap=e;xt=e}}function y(e){if(Rt!==e){dt.lineJoin=e;Rt=e}}function T(e){if(Et!==e){dt.strokeStyle=e;Et=e}}function x(e){if(yt!==e){dt.fillStyle=e;yt=e}}function R(e,t){if(bt!==e||_t!==t){dt.setLineDash([e,t]);bt=e;_t=t}}console.log("THREE.CanvasRenderer",THREE.REVISION);var b=THREE.Math.smoothstep;e=e||{};var _,w,H,M,S,C,A,D,P,L,N,F,k,z,O,I,V,U,B,j,G,W,X,q,Y,K,Z,Q,$,J,et,tt,it,rt,at,nt,ot,st,lt,ct,ht=this,ut=new THREE.Projector,ft=void 0!==e.canvas?e.canvas:document.createElement("canvas"),dt=ft.getContext("2d"),pt=new THREE.Color(0),mt=0,vt=1,gt=0,Et=null,yt=null,Tt=null,xt=null,Rt=null,bt=null,_t=0,wt=new THREE.RenderableVertex,Ht=new THREE.RenderableVertex,Mt=new THREE.Color,St=new THREE.Color,Ct=new THREE.Color,At=new THREE.Color,Dt=new THREE.Color,Pt=new THREE.Color,Lt=new THREE.Color,Nt=new THREE.Color,Ft={},kt={},zt=new THREE.Box2,Ot=new THREE.Box2,It=new THREE.Box2,Vt=new THREE.Color,Ut=new THREE.Color,Bt=new THREE.Color,jt=new THREE.Vector3,Gt=16;at=document.createElement("canvas");at.width=at.height=2;nt=at.getContext("2d");nt.fillStyle="rgba(0,0,0,1)";nt.fillRect(0,0,2,2);ot=nt.getImageData(0,0,2,2);st=ot.data;lt=document.createElement("canvas");lt.width=lt.height=Gt;ct=lt.getContext("2d");ct.translate(-Gt/2,-Gt/2);ct.scale(Gt,Gt);Gt--;if(void 0===dt.setLineDash)if(void 0!==dt.mozDash)dt.setLineDash=function(e){dt.mozDash=null!==e[0]?e:null};else dt.setLineDash=function(){};this.domElement=ft;this.devicePixelRatio=void 0!==e.devicePixelRatio?e.devicePixelRatio:void 0!==window.devicePixelRatio?window.devicePixelRatio:1;this.autoClear=!0;this.sortObjects=!0;this.sortElements=!0;this.info={render:{vertices:0,faces:0}};this.supportsVertexTextures=function(){};this.setFaceCulling=function(){};this.setSize=function(e,t,i){M=e*this.devicePixelRatio;S=t*this.devicePixelRatio;C=Math.floor(M/2);A=Math.floor(S/2);ft.width=M;ft.height=S;if(1!==this.devicePixelRatio&&i!==!1){ft.style.width=e+"px";ft.style.height=t+"px"}zt.set(new THREE.Vector2(-C,-A),new THREE.Vector2(C,A));Ot.set(new THREE.Vector2(-C,-A),new THREE.Vector2(C,A));vt=1;gt=0;Et=null;yt=null;Tt=null;xt=null;Rt=null};this.setClearColor=function(e,t){pt.set(e);mt=void 0!==t?t:1;Ot.set(new THREE.Vector2(-C,-A),new THREE.Vector2(C,A))};this.setClearColorHex=function(e,t){console.warn("DEPRECATED: .setClearColorHex() is being removed. Use .setClearColor() instead.");this.setClearColor(e,t)};this.getMaxAnisotropy=function(){return 0};this.clear=function(){dt.setTransform(1,0,0,-1,C,A);if(Ot.empty()===!1){Ot.intersect(zt);Ot.expandByScalar(2);if(1>mt)dt.clearRect(0|Ot.min.x,0|Ot.min.y,0|Ot.max.x-Ot.min.x,0|Ot.max.y-Ot.min.y);if(mt>0){v(THREE.NormalBlending);m(1);x("rgba("+Math.floor(255*pt.r)+","+Math.floor(255*pt.g)+","+Math.floor(255*pt.b)+","+mt+")");dt.fillRect(0|Ot.min.x,0|Ot.min.y,0|Ot.max.x-Ot.min.x,0|Ot.max.y-Ot.min.y)}Ot.makeEmpty()}};this.render=function(e,i){if(i instanceof THREE.Camera!=!1){if(this.autoClear===!0)this.clear();dt.setTransform(1,0,0,-1,C,A);ht.info.render.vertices=0;ht.info.render.faces=0;_=ut.projectScene(e,i,this.sortObjects,this.sortElements);w=_.elements;H=_.lights;D=i;t();for(var s=0,l=w.length;l>s;s++){var c=w[s];var h=c.material;if(void 0!==h&&h.visible!==!1){It.makeEmpty();if(c instanceof THREE.RenderableParticle){P=c;P.x*=C;P.y*=A;r(P,c,h)}else if(c instanceof THREE.RenderableLine){P=c.v1;L=c.v2;P.positionScreen.x*=C;P.positionScreen.y*=A;L.positionScreen.x*=C;L.positionScreen.y*=A;It.setFromPoints([P.positionScreen,L.positionScreen]);if(zt.isIntersectionBox(It)===!0)a(P,L,c,h)}else if(c instanceof THREE.RenderableFace3){P=c.v1;L=c.v2;N=c.v3;if(P.positionScreen.z<-1||P.positionScreen.z>1)continue;if(L.positionScreen.z<-1||L.positionScreen.z>1)continue;if(N.positionScreen.z<-1||N.positionScreen.z>1)continue;P.positionScreen.x*=C;P.positionScreen.y*=A;L.positionScreen.x*=C;L.positionScreen.y*=A;N.positionScreen.x*=C;N.positionScreen.y*=A;if(h.overdraw>0){p(P.positionScreen,L.positionScreen,h.overdraw);p(L.positionScreen,N.positionScreen,h.overdraw);p(N.positionScreen,P.positionScreen,h.overdraw)}It.setFromPoints([P.positionScreen,L.positionScreen,N.positionScreen]);if(zt.isIntersectionBox(It)===!0)n(P,L,N,0,1,2,c,h)}else if(c instanceof THREE.RenderableFace4){P=c.v1;L=c.v2;N=c.v3;F=c.v4;if(P.positionScreen.z<-1||P.positionScreen.z>1)continue;if(L.positionScreen.z<-1||L.positionScreen.z>1)continue;if(N.positionScreen.z<-1||N.positionScreen.z>1)continue;if(F.positionScreen.z<-1||F.positionScreen.z>1)continue;P.positionScreen.x*=C;P.positionScreen.y*=A;L.positionScreen.x*=C;L.positionScreen.y*=A;N.positionScreen.x*=C;N.positionScreen.y*=A;F.positionScreen.x*=C;F.positionScreen.y*=A;wt.positionScreen.copy(L.positionScreen);Ht.positionScreen.copy(F.positionScreen);if(h.overdraw>0){p(P.positionScreen,L.positionScreen,h.overdraw);p(L.positionScreen,F.positionScreen,h.overdraw);p(F.positionScreen,P.positionScreen,h.overdraw);p(N.positionScreen,wt.positionScreen,h.overdraw);p(N.positionScreen,Ht.positionScreen,h.overdraw)}It.setFromPoints([P.positionScreen,L.positionScreen,N.positionScreen,F.positionScreen]);if(zt.isIntersectionBox(It)===!0)o(P,L,N,F,wt,Ht,c,h)}Ot.union(It)}else;}dt.setTransform(1,0,0,1,0,0)}else console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.")}};