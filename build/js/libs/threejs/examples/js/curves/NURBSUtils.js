THREE.NURBSUtils={findSpan:function(e,t,i){var r=i.length-e-1;if(t>=i[r])return r-1;if(t<=i[e])return e;var n=e;var o=r;var a=Math.floor((n+o)/2);for(;t<i[a]||t>=i[a+1];){if(t<i[a])o=a;else n=a;a=Math.floor((n+o)/2)}return a},calcBasisFunctions:function(e,t,i,r){var n=[];var o=[];var a=[];n[0]=1;for(var s=1;i>=s;++s){o[s]=t-r[e+1-s];a[s]=r[e+s]-t;var l=0;for(var h=0;s>h;++h){var c=a[h+1];var u=o[s-h];var f=n[h]/(c+u);n[h]=l+c*f;l=u*f}n[s]=l}return n},calcBSplinePoint:function(e,t,i,r){var n=this.findSpan(e,r,t);var o=this.calcBasisFunctions(n,r,e,t);var a=new THREE.Vector4(0,0,0,0);for(var s=0;e>=s;++s){var l=i[n-e+s];var h=o[s];var c=l.w*h;a.x+=l.x*c;a.y+=l.y*c;a.z+=l.z*c;a.w+=l.w*h}return a},calcBasisFunctionDerivatives:function(e,t,i,r,n){var o=[];for(var a=0;i>=a;++a)o[a]=0;var s=[];for(var a=0;r>=a;++a)s[a]=o.slice(0);var l=[];for(var a=0;i>=a;++a)l[a]=o.slice(0);l[0][0]=1;var h=o.slice(0);var c=o.slice(0);for(var u=1;i>=u;++u){h[u]=t-n[e+1-u];c[u]=n[e+u]-t;var f=0;for(var d=0;u>d;++d){var p=c[d+1];var m=h[u-d];l[u][d]=p+m;var v=l[d][u-1]/l[u][d];l[d][u]=f+p*v;f=m*v}l[u][u]=f}for(var u=0;i>=u;++u)s[0][u]=l[u][i];for(var d=0;i>=d;++d){var g=0;var E=1;var y=[];for(var a=0;i>=a;++a)y[a]=o.slice(0);y[0][0]=1;for(var T=1;r>=T;++T){var _=0;var b=d-T;var x=i-T;if(d>=T){y[E][0]=y[g][0]/l[x+1][b];_=y[E][0]*l[b][x]}var R=b>=-1?1:-b;var w=x>=d-1?T-1:i-d;for(var u=R;w>=u;++u){y[E][u]=(y[g][u]-y[g][u-1])/l[x+1][b+u];_+=y[E][u]*l[b+u][x]}if(x>=d){y[E][T]=-y[g][T-1]/l[x+1][d];_+=y[E][T]*l[d][x]}s[T][d]=_;var u=g;g=E;E=u}}var d=i;for(var T=1;r>=T;++T){for(var u=0;i>=u;++u)s[T][u]*=d;d*=i-T}return s},calcBSplineDerivatives:function(e,t,i,r,n){var o=e>n?n:e;var a=[];var s=this.findSpan(e,r,t);var l=this.calcBasisFunctionDerivatives(s,r,e,o,t);var h=[];for(var c=0;c<i.length;++c){var u=i[c].clone();var f=u.w;u.x*=f;u.y*=f;u.z*=f;h[c]=u}for(var d=0;o>=d;++d){var u=h[s-e].clone().multiplyScalar(l[d][0]);for(var p=1;e>=p;++p)u.add(h[s-e+p].clone().multiplyScalar(l[d][p]));a[d]=u}for(var d=o+1;n+1>=d;++d)a[d]=new THREE.Vector4(0,0,0);return a},calcKoverI:function(e,t){var i=1;for(var r=2;e>=r;++r)i*=r;var n=1;for(var r=2;t>=r;++r)n*=r;for(var r=2;e-t>=r;++r)n*=r;return i/n},calcRationalCurveDerivatives:function(e){var t=e.length;var i=[];var r=[];for(var n=0;t>n;++n){var o=e[n];i[n]=new THREE.Vector3(o.x,o.y,o.z);r[n]=o.w}var a=[];for(var s=0;t>s;++s){var l=i[s].clone();for(var n=1;s>=n;++n)l.sub(a[s-n].clone().multiplyScalar(this.calcKoverI(s,n)*r[n]));a[s]=l.divideScalar(r[0])}return a},calcNURBSDerivatives:function(e,t,i,r,n){var o=this.calcBSplineDerivatives(e,t,i,r,n);return this.calcRationalCurveDerivatives(o)},calcSurfacePoint:function(e,t,i,r,n,o,a){var s=this.findSpan(e,o,i);var l=this.findSpan(t,a,r);var h=this.calcBasisFunctions(s,o,e,i);var c=this.calcBasisFunctions(l,a,t,r);var u=[];for(var f=0;t>=f;++f){u[f]=new THREE.Vector4(0,0,0,0);for(var d=0;e>=d;++d){var p=n[s-e+d][l-t+f].clone();var m=p.w;p.x*=m;p.y*=m;p.z*=m;u[f].add(p.multiplyScalar(h[d]))}}var v=new THREE.Vector4(0,0,0,0);for(var f=0;t>=f;++f)v.add(u[f].multiplyScalar(c[f]));v.divideScalar(v.w);return new THREE.Vector3(v.x,v.y,v.z)}};