THREE.OculusRiftEffect=function(e,t){var i=t&&t.worldFactor?t.worldFactor:1;var r=t&&t.HMD?t.HMD:{hResolution:1280,vResolution:800,hScreenSize:.14976,vScreenSize:.0936,interpupillaryDistance:.064,lensSeparationDistance:.064,eyeToScreenDistance:.041,distortionK:[1,.22,.24,0],chromaAbParameter:[.996,-.004,1.014,0]};var n=new THREE.PerspectiveCamera;n.matrixAutoUpdate=!1;n.target=new THREE.Vector3;var o=new THREE.OrthographicCamera(-1,1,1,-1,1,1e3);o.position.z=1;this.preLeftRender=function(){};this.preRightRender=function(){};e.autoClear=!1;var a=new THREE.Color("black");var s={minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat};var l=new THREE.WebGLRenderTarget(640,800,s);var h=new THREE.ShaderMaterial({uniforms:{texid:{type:"t",value:l},scale:{type:"v2",value:new THREE.Vector2(1,1)},scaleIn:{type:"v2",value:new THREE.Vector2(1,1)},lensCenter:{type:"v2",value:new THREE.Vector2(0,0)},hmdWarpParam:{type:"v4",value:new THREE.Vector4(1,0,0,0)},chromAbParam:{type:"v4",value:new THREE.Vector4(1,0,0,0)}},vertexShader:["varying vec2 vUv;","void main() {"," vUv = uv;","	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec2 scale;","uniform vec2 scaleIn;","uniform vec2 lensCenter;","uniform vec4 hmdWarpParam;","uniform vec4 chromAbParam;","uniform sampler2D texid;","varying vec2 vUv;","void main()","{","  vec2 uv = (vUv*2.0)-1.0;","  vec2 theta = (uv-lensCenter)*scaleIn;","  float rSq = theta.x*theta.x + theta.y*theta.y;","  vec2 rvector = theta*(hmdWarpParam.x + hmdWarpParam.y*rSq + hmdWarpParam.z*rSq*rSq + hmdWarpParam.w*rSq*rSq*rSq);","  vec2 rBlue = rvector * (chromAbParam.z + chromAbParam.w * rSq);","  vec2 tcBlue = (lensCenter + scale * rBlue);","  tcBlue = (tcBlue+1.0)/2.0;","  if (any(bvec2(clamp(tcBlue, vec2(0.0,0.0), vec2(1.0,1.0))-tcBlue))) {","    gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);","    return;}","  vec2 tcGreen = lensCenter + scale * rvector;","  tcGreen = (tcGreen+1.0)/2.0;","  vec2 rRed = rvector * (chromAbParam.x + chromAbParam.y * rSq);","  vec2 tcRed = lensCenter + scale * rRed;","  tcRed = (tcRed+1.0)/2.0;","  gl_FragColor = vec4(texture2D(texid, tcRed).r, texture2D(texid, tcGreen).g, texture2D(texid, tcBlue).b, 1);","}"].join("\n")});var c=new THREE.Mesh(new THREE.PlaneGeometry(2,2),h);var u=new THREE.Scene;u.add(o);u.add(c);var f={},d={};var p=1;this.setHMD=function(e){r=e;var t=r.hResolution/(2*r.vResolution);var n=-1-4*(r.hScreenSize/4-r.lensSeparationDistance/2)/r.hScreenSize;p=r.distortionK[0]+r.distortionK[1]*Math.pow(n,2)+r.distortionK[2]*Math.pow(n,4)+r.distortionK[3]*Math.pow(n,6);var o=THREE.Math.radToDeg(2*Math.atan2(r.vScreenSize*p,2*r.eyeToScreenDistance));var a=(new THREE.Matrix4).makePerspective(o,t,.3,1e4);var c=4*(r.hScreenSize/4-r.interpupillaryDistance/2)/r.hScreenSize;f.proj=(new THREE.Matrix4).makeTranslation(c,0,0).multiply(a);d.proj=(new THREE.Matrix4).makeTranslation(-c,0,0).multiply(a);f.tranform=(new THREE.Matrix4).makeTranslation(-i*r.interpupillaryDistance/2,0,0);d.tranform=(new THREE.Matrix4).makeTranslation(i*r.interpupillaryDistance/2,0,0);f.viewport=[0,0,r.hResolution/2,r.vResolution];d.viewport=[r.hResolution/2,0,r.hResolution/2,r.vResolution];var u=4*(r.hScreenSize/4-r.lensSeparationDistance/2)/r.hScreenSize;f.lensCenter=new THREE.Vector2(u,0);d.lensCenter=new THREE.Vector2(-u,0);h.uniforms["hmdWarpParam"].value=new THREE.Vector4(r.distortionK[0],r.distortionK[1],r.distortionK[2],r.distortionK[3]);h.uniforms["chromAbParam"].value=new THREE.Vector4(r.chromaAbParameter[0],r.chromaAbParameter[1],r.chromaAbParameter[2],r.chromaAbParameter[3]);h.uniforms["scaleIn"].value=new THREE.Vector2(1,1/t);h.uniforms["scale"].value=new THREE.Vector2(1/p,1*t/p);if(l)l.dispose();l=new THREE.WebGLRenderTarget(r.hResolution*p/2,r.vResolution*p,s);h.uniforms["texid"].value=l};this.getHMD=function(){return r};this.setHMD(r);this.setSize=function(t,i){f.viewport=[t/2-r.hResolution/2,i/2-r.vResolution/2,r.hResolution/2,r.vResolution];d.viewport=[t/2,i/2-r.vResolution/2,r.hResolution/2,r.vResolution];e.setSize(t,i)};this.render=function(t,i){var r=e.getClearColor().clone();e.setClearColor(a);e.clear();e.setClearColor(r);if(i.matrixAutoUpdate)i.updateMatrix();this.preLeftRender();n.projectionMatrix.copy(f.proj);n.matrix.copy(i.matrix).multiply(f.tranform);n.matrixWorldNeedsUpdate=!0;e.setViewport(f.viewport[0],f.viewport[1],f.viewport[2],f.viewport[3]);h.uniforms["lensCenter"].value=f.lensCenter;e.render(t,n,l,!0);e.render(u,o);this.preRightRender();n.projectionMatrix.copy(d.proj);n.matrix.copy(i.matrix).multiply(d.tranform);n.matrixWorldNeedsUpdate=!0;e.setViewport(d.viewport[0],d.viewport[1],d.viewport[2],d.viewport[3]);h.uniforms["lensCenter"].value=d.lensCenter;e.render(t,n,l,!0);e.render(u,o)};this.dispose=function(){if(h)h.dispose();if(l)l.dispose()}};