function plane(e,t){return function(i,r){var n=(i-.5)*e,o=(r+.5)*t,a=0;return new THREE.Vector3(n,o,a)}}function Particle(e,t,i,r){this.position=clothFunction(e,t),this.previous=clothFunction(e,t),this.original=clothFunction(e,t),this.a=new THREE.Vector3(0,0,0),this.mass=r,this.invMass=1/r,this.tmp=new THREE.Vector3,this.tmp2=new THREE.Vector3}function satisifyConstrains(e,t,i){diff.subVectors(t.position,e.position);var r=diff.length();if(0!=r){var n=diff.multiplyScalar(1-i/r),o=n.multiplyScalar(.5);e.position.add(o),t.position.sub(o)}}function Cloth(e,t){function i(t,i){return t+i*(e+1)}e=e||10,t=t||10,this.w=e,this.h=t;var r,n,o=[],a=[];for(n=0;t>=n;n++)for(r=0;e>=r;r++)o.push(new Particle(r/e,n/t,0,MASS));for(n=0;t>n;n++)for(r=0;e>r;r++)a.push([o[i(r,n)],o[i(r,n+1)],restDistance]),a.push([o[i(r,n)],o[i(r+1,n)],restDistance]);for(r=e,n=0;t>n;n++)a.push([o[i(r,n)],o[i(r,n+1)],restDistance]);for(n=t,r=0;e>r;r++)a.push([o[i(r,n)],o[i(r+1,n)],restDistance]);this.particles=o,this.constrains=a,this.index=i}function simulate(e){if(!lastTime)return lastTime=e,void 0;var t,i,r,n,o,a;if(wind){var s,l,h=clothGeometry.faces;for(r=cloth.particles,t=0,i=h.length;i>t;t++)s=h[t],l=s.normal,tmpForce.copy(l).normalize().multiplyScalar(l.dot(windForce)),r[s.a].addForce(tmpForce),r[s.b].addForce(tmpForce),r[s.c].addForce(tmpForce)}for(r=cloth.particles,t=0,i=r.length;i>t;t++)n=r[t],n.addForce(gravity),n.integrate(TIMESTEP_SQ);for(o=cloth.constrains,i=o.length,t=0;i>t;t++)a=o[t],satisifyConstrains(a[0],a[1],a[2]);if(ballPosition.z=90*-Math.sin(Date.now()/600),ballPosition.x=70*Math.cos(Date.now()/400),sphere.visible)for(r=cloth.particles,t=0,i=r.length;i>t;t++)n=r[t],pos=n.position,diff.subVectors(pos,ballPosition),diff.length()<ballSize&&(diff.normalize().multiplyScalar(ballSize),pos.copy(ballPosition).add(diff));for(r=cloth.particles,t=0,i=r.length;i>t;t++)n=r[t],pos=n.position,pos.y<-250&&(pos.y=-250);for(t=0,i=pins.length;i>t;t++){var c=pins[t],u=r[c];u.position.copy(u.original),u.previous.copy(u.original)}}var DAMPING=.03,DRAG=1-DAMPING,MASS=.1,restDistance=25,xSegs=10,ySegs=10,clothFunction=plane(restDistance*xSegs,restDistance*ySegs),cloth=new Cloth(xSegs,ySegs),GRAVITY=981*1.4,gravity=new THREE.Vector3(0,-GRAVITY,0).multiplyScalar(MASS),TIMESTEP=.018,TIMESTEP_SQ=TIMESTEP*TIMESTEP,pins=[],wind=!0,windStrength=2,windForce=new THREE.Vector3(0,0,0),ballPosition=new THREE.Vector3(0,-45,0),ballSize=60,tmpForce=new THREE.Vector3,lastTime;Particle.prototype.addForce=function(e){this.a.add(this.tmp2.copy(e).multiplyScalar(this.invMass))},Particle.prototype.integrate=function(e){var t=this.tmp.subVectors(this.position,this.previous);t.multiplyScalar(DRAG).add(this.position),t.add(this.a.multiplyScalar(e)),this.tmp=this.previous,this.previous=this.position,this.position=t,this.a.set(0,0,0)};var diff=new THREE.Vector3;