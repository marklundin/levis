THREE.CTMLoader=function(e){THREE.Loader.call(this,e)};THREE.CTMLoader.prototype=Object.create(THREE.Loader.prototype);THREE.CTMLoader.prototype.loadParts=function(e,t,i){var r=this;var n=new XMLHttpRequest;var o=i.basePath?i.basePath:this.extractUrlBase(e);n.onreadystatechange=function(){function e(e){h+=1;l.push(e);if(h===a.offsets.length)t(l,s)}if(4===n.readyState)if(200===n.status||0===n.status){var a=JSON.parse(n.responseText);var s=[],l=[],h=0;for(var c=0;c<a.materials.length;c++)s[c]=THREE.Loader.prototype.createMaterial(a.materials[c],o);var u=o+a.data;var f={useWorker:i.useWorker,useBuffers:i.useBuffers,offsets:a.offsets};r.load(u,e,f)}};n.open("GET",e,!0);if(n.overrideMimeType)n.overrideMimeType("text/plain; charset=x-user-defined");n.setRequestHeader("Content-Type","text/plain");n.send(null)};THREE.CTMLoader.prototype.load=function(e,t,i){var r=this;var n=void 0!==i.offsets?i.offsets:[0];var o=void 0!==i.useBuffers?i.useBuffers:!0;var a=new XMLHttpRequest,s=null;var l=0;a.onreadystatechange=function(){if(4===a.readyState)if(200===a.status||0===a.status){var h=a.responseText;if(i.useWorker){var c=new Worker("js/loaders/ctm/CTMWorker.js");c.onmessage=function(e){var i=e.data;for(var n=0;n<i.length;n++){var a=i[n];if(o)r.createModelBuffers(a,t);else r.createModelClassic(a,t)}};c.postMessage({data:h,offsets:n})}else for(var u=0;u<n.length;u++){var f=new CTM.Stream(h);f.offset=n[u];var d=new CTM.File(f);if(o)r.createModelBuffers(d,t);else r.createModelClassic(d,t)}}else console.error("Couldn't load ["+e+"] ["+a.status+"]");else if(3===a.readyState){if(s){if(0===l)l=a.getResponseHeader("Content-Length");s({total:l,loaded:a.responseText.length})}}else if(2===a.readyState)l=a.getResponseHeader("Content-Length")};a.overrideMimeType("text/plain; charset=x-user-defined");a.open("GET",e,!0);a.send(null)};THREE.CTMLoader.prototype.createModelBuffers=function(e,t){var i=function(){function t(e){if(void 0===p[e]){p[e]=m;var t=3*e,i=3*e+1,r=3*e+2,n=3*m,h=3*m+1,v=3*m+2;c[n]=o[t];c[h]=o[i];c[v]=o[r];if(a){u[n]=a[t];u[h]=a[i];u[v]=a[r]}if(s){f[2*m]=s[2*e];f[2*m+1]=s[2*e+1]}if(l){d[4*m]=l[4*e];d[4*m+1]=l[4*e+1];d[4*m+2]=l[4*e+2];d[4*m+3]=l[4*e+3]}m+=1}}var i=this;var r=!0;i.materials=[];THREE.BufferGeometry.call(this);var n=e.body.indices,o=e.body.vertices,a=e.body.normals;var s,l;if(void 0!==e.body.uvMaps&&e.body.uvMaps.length>0)s=e.body.uvMaps[0].uv;if(void 0!==e.body.attrMaps&&e.body.attrMaps.length>0&&"Color"===e.body.attrMaps[0].name)l=e.body.attrMaps[0].attr;if(r){var h=new Uint32Array(n.length),c=new Float32Array(o.length);var u,f,d;if(a)u=new Float32Array(a.length);if(s)f=new Float32Array(s.length);if(l)d=new Float32Array(l.length);var p={},m=0;var v,g,E;for(var y=0;y<n.length;y+=3){v=n[y];g=n[y+1];E=n[y+2];t(v);t(g);t(E);h[y]=p[v];h[y+1]=p[g];h[y+2]=p[E]}n=h;o=c;if(a)a=u;if(s)s=f;if(l)l=d}i.offsets=[];var _=n;var T=0,b=o.length,x=0,w=b;for(var y=0;y<_.length;){for(var R=0;3>R;++R){var H=_[y++];if(b>H)b=H;if(H>x)x=H}if(x-b>65535){y-=3;for(var S=T;y>S;++S)_[S]-=w;i.offsets.push({start:T,count:y-T,index:w});T=y;b=o.length;x=0}w=b}for(var S=T;y>S;++S)_[S]-=w;i.offsets.push({start:T,count:y-T,index:w});var M=new Uint16Array(n);var C=i.attributes;C["index"]={itemSize:1,array:M,numItems:M.length};C["position"]={itemSize:3,array:o,numItems:o.length};if(void 0!==a)C["normal"]={itemSize:3,array:a,numItems:a.length};if(void 0!==s)C["uv"]={itemSize:2,array:s,numItems:s.length};if(void 0!==l)C["color"]={itemSize:4,array:l,numItems:l.length}};i.prototype=Object.create(THREE.BufferGeometry.prototype);var r=new i;if(void 0===r.attributes["normal"])r.computeVertexNormals();t(r)};THREE.CTMLoader.prototype.createModelClassic=function(e,t){function i(e,t,i,r){e.vertices.push(new THREE.Vector3(t,i,r))}function r(e,t,i,r,n){var o=new THREE.Face3(t,i,r,null,null,n);e.faces.push(o);return o}function n(e,t,i,r,n,o,a,s,l){var h=t[3*a],c=t[3*a+1],u=t[3*a+2],f=t[3*s],d=t[3*s+1],p=t[3*s+2],m=t[3*l],v=t[3*l+1],g=t[3*l+2];var E=new THREE.Vector3(h,c,u),y=new THREE.Vector3(f,d,p),_=new THREE.Vector3(m,v,g);var T=new THREE.Face3(i,r,n,[E,y,_],null,o);e.faces.push(T);return T}function o(e,t,i,r,n,o,a){var s=[];s.push(new THREE.Vector2(t,i));s.push(new THREE.Vector2(r,n));s.push(new THREE.Vector2(o,a));e.push(s)}var a=function(){function t(e){var t,r,n,o,a=e.length;for(o=0;a>o;o+=3){t=e[o];r=e[o+1];n=e[o+2];i(c,t,r,n)}}function a(e){var t,i,r,n,o=e.length;for(n=0;o>n;n+=3){t=e[n];i=e[n+1];r=e[n+2];u.push(t,i,r)}}function s(e){var t,i,r,n,o,a=e.length;for(o=0;a>o;o+=4){t=e[o];i=e[o+1];r=e[o+2];n=e[o+3];var s=new THREE.Color;s.setRGB(t,i,r);d.push(s)}}function l(e){var t,i,r,n=e.length;for(r=0;n>r;r+=2){t=e[r];i=e[r+1];f.push(t,i)}}function h(e){var t,i,a,s,l,h,g,E,y,_,T,b,x=e.length;_=0;for(b=0;x>b;b+=3){t=e[b];i=e[b+1];a=e[b+2];if(p)T=n(c,u,t,i,a,_,t,i,a);else T=r(c,t,i,a,_);if(v){T.vertexColors[0]=d[t];T.vertexColors[1]=d[i];T.vertexColors[2]=d[a]}if(m){s=f[2*t];l=f[2*t+1];h=f[2*i];g=f[2*i+1];E=f[2*a];y=f[2*a+1];o(c.faceVertexUvs[0],s,l,h,g,E,y)}}}var c=this;c.materials=[];THREE.Geometry.call(this);var u=[],f=[],d=[];t(e.body.vertices);if(void 0!==e.body.normals)a(e.body.normals);if(void 0!==e.body.uvMaps&&e.body.uvMaps.length>0)l(e.body.uvMaps[0].uv);if(void 0!==e.body.attrMaps&&e.body.attrMaps.length>0&&"Color"===e.body.attrMaps[0].name)s(e.body.attrMaps[0].attr);var p=u.length>0?!0:!1,m=f.length>0?!0:!1,v=d.length>0?!0:!1;h(e.body.indices);this.computeCentroids();this.computeFaceNormals()};a.prototype=Object.create(THREE.Geometry.prototype);t(new a)};