THREE.CTMLoader=function(e){THREE.Loader.call(this,e)},THREE.CTMLoader.prototype=Object.create(THREE.Loader.prototype),THREE.CTMLoader.prototype.loadParts=function(e,t,i){var r=this,n=new XMLHttpRequest,o=i.basePath?i.basePath:this.extractUrlBase(e);n.onreadystatechange=function(){function e(e){h+=1,l.push(e),h===a.offsets.length&&t(l,s)}if(4===n.readyState&&(200===n.status||0===n.status)){for(var a=JSON.parse(n.responseText),s=[],l=[],h=0,c=0;c<a.materials.length;c++)s[c]=THREE.Loader.prototype.createMaterial(a.materials[c],o);var u=o+a.data,d={useWorker:i.useWorker,useBuffers:i.useBuffers,offsets:a.offsets};r.load(u,e,d)}},n.open("GET",e,!0),n.overrideMimeType&&n.overrideMimeType("text/plain; charset=x-user-defined"),n.setRequestHeader("Content-Type","text/plain"),n.send(null)},THREE.CTMLoader.prototype.load=function(e,t,i){var r=this,n=void 0!==i.offsets?i.offsets:[0],o=void 0!==i.useBuffers?i.useBuffers:!0,a=new XMLHttpRequest,s=null,l=0;a.onreadystatechange=function(){if(4===a.readyState)if(200===a.status||0===a.status){var h=a.responseText;if(i.useWorker){var c=new Worker("js/loaders/ctm/CTMWorker.js");c.onmessage=function(e){for(var i=e.data,n=0;n<i.length;n++){var a=i[n];o?r.createModelBuffers(a,t):r.createModelClassic(a,t)}},c.postMessage({data:h,offsets:n})}else for(var u=0;u<n.length;u++){var d=new CTM.Stream(h);d.offset=n[u];var p=new CTM.File(d);o?r.createModelBuffers(p,t):r.createModelClassic(p,t)}}else console.error("Couldn't load ["+e+"] ["+a.status+"]");else 3===a.readyState?s&&(0===l&&(l=a.getResponseHeader("Content-Length")),s({total:l,loaded:a.responseText.length})):2===a.readyState&&(l=a.getResponseHeader("Content-Length"))},a.overrideMimeType("text/plain; charset=x-user-defined"),a.open("GET",e,!0),a.send(null)},THREE.CTMLoader.prototype.createModelBuffers=function(e,t){var i=function(){function t(e){if(void 0===v[e]){v[e]=E;var t=3*e,i=3*e+1,r=3*e+2,a=3*E,d=3*E+1,f=3*E+2;p[a]=s[t],p[d]=s[i],p[f]=s[r],l&&(h[a]=l[t],h[d]=l[i],h[f]=l[r]),n&&(c[2*E]=n[2*e],c[2*E+1]=n[2*e+1]),o&&(u[4*E]=o[4*e],u[4*E+1]=o[4*e+1],u[4*E+2]=o[4*e+2],u[4*E+3]=o[4*e+3]),E+=1}}var i=this,r=!0;i.materials=[],THREE.BufferGeometry.call(this);var n,o,a=e.body.indices,s=e.body.vertices,l=e.body.normals;if(void 0!==e.body.uvMaps&&e.body.uvMaps.length>0&&(n=e.body.uvMaps[0].uv),void 0!==e.body.attrMaps&&e.body.attrMaps.length>0&&"Color"===e.body.attrMaps[0].name&&(o=e.body.attrMaps[0].attr),r){var h,c,u,d=new Uint32Array(a.length),p=new Float32Array(s.length);l&&(h=new Float32Array(l.length)),n&&(c=new Float32Array(n.length)),o&&(u=new Float32Array(o.length));for(var f,m,g,v={},E=0,y=0;y<a.length;y+=3)f=a[y],m=a[y+1],g=a[y+2],t(f),t(m),t(g),d[y]=v[f],d[y+1]=v[m],d[y+2]=v[g];a=d,s=p,l&&(l=h),n&&(n=c),o&&(o=u)}i.offsets=[];for(var _=a,T=0,b=s.length,x=0,w=b,y=0;y<_.length;){for(var R=0;3>R;++R){var H=_[y++];b>H&&(b=H),H>x&&(x=H)}if(x-b>65535){y-=3;for(var S=T;y>S;++S)_[S]-=w;i.offsets.push({start:T,count:y-T,index:w}),T=y,b=s.length,x=0}w=b}for(var S=T;y>S;++S)_[S]-=w;i.offsets.push({start:T,count:y-T,index:w});var M=new Uint16Array(a),C=i.attributes;C.index={itemSize:1,array:M,numItems:M.length},C.position={itemSize:3,array:s,numItems:s.length},void 0!==l&&(C.normal={itemSize:3,array:l,numItems:l.length}),void 0!==n&&(C.uv={itemSize:2,array:n,numItems:n.length}),void 0!==o&&(C.color={itemSize:4,array:o,numItems:o.length})};i.prototype=Object.create(THREE.BufferGeometry.prototype);var r=new i;void 0===r.attributes.normal&&r.computeVertexNormals(),t(r)},THREE.CTMLoader.prototype.createModelClassic=function(e,t){function i(e,t,i,r){e.vertices.push(new THREE.Vector3(t,i,r))}function r(e,t,i,r,n){var o=new THREE.Face3(t,i,r,null,null,n);return e.faces.push(o),o}function n(e,t,i,r,n,o,a,s,l){var h=t[3*a],c=t[3*a+1],u=t[3*a+2],d=t[3*s],p=t[3*s+1],f=t[3*s+2],m=t[3*l],g=t[3*l+1],v=t[3*l+2],E=new THREE.Vector3(h,c,u),y=new THREE.Vector3(d,p,f),_=new THREE.Vector3(m,g,v),T=new THREE.Face3(i,r,n,[E,y,_],null,o);return e.faces.push(T),T}function o(e,t,i,r,n,o,a){var s=[];s.push(new THREE.Vector2(t,i)),s.push(new THREE.Vector2(r,n)),s.push(new THREE.Vector2(o,a)),e.push(s)}var a=function(){function t(e){var t,r,n,o,a=e.length;for(o=0;a>o;o+=3)t=e[o],r=e[o+1],n=e[o+2],i(c,t,r,n)}function a(e){var t,i,r,n,o=e.length;for(n=0;o>n;n+=3)t=e[n],i=e[n+1],r=e[n+2],u.push(t,i,r)}function s(e){var t,i,r,n,o,a=e.length;for(o=0;a>o;o+=4){t=e[o],i=e[o+1],r=e[o+2],n=e[o+3];var s=new THREE.Color;s.setRGB(t,i,r),p.push(s)}}function l(e){var t,i,r,n=e.length;for(r=0;n>r;r+=2)t=e[r],i=e[r+1],d.push(t,i)}function h(e){var t,i,a,s,l,h,v,E,y,_,T,b,x=e.length;for(_=0,b=0;x>b;b+=3)t=e[b],i=e[b+1],a=e[b+2],T=f?n(c,u,t,i,a,_,t,i,a):r(c,t,i,a,_),g&&(T.vertexColors[0]=p[t],T.vertexColors[1]=p[i],T.vertexColors[2]=p[a]),m&&(s=d[2*t],l=d[2*t+1],h=d[2*i],v=d[2*i+1],E=d[2*a],y=d[2*a+1],o(c.faceVertexUvs[0],s,l,h,v,E,y))}var c=this;c.materials=[],THREE.Geometry.call(this);var u=[],d=[],p=[];t(e.body.vertices),void 0!==e.body.normals&&a(e.body.normals),void 0!==e.body.uvMaps&&e.body.uvMaps.length>0&&l(e.body.uvMaps[0].uv),void 0!==e.body.attrMaps&&e.body.attrMaps.length>0&&"Color"===e.body.attrMaps[0].name&&s(e.body.attrMaps[0].attr);var f=u.length>0?!0:!1,m=d.length>0?!0:!1,g=p.length>0?!0:!1;h(e.body.indices),this.computeCentroids(),this.computeFaceNormals()};a.prototype=Object.create(THREE.Geometry.prototype),t(new a)};