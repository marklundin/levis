/*
 * @author zz85 (http://github.com/zz85 http://www.lab4games.net/zz85/blog)
 *
 * a simple to use javascript 3d particles system inspired by FliNT and Stardust
 * created with TWEEN.js and THREE.js
 *
 * for feature requests or bugs, please visit https://github.com/zz85/sparks.js
 *
 * licensed under the MIT license
 */

var SPARKS={};SPARKS.Emitter=function(e){this._counter=e?e:new SPARKS.SteadyCounter(10),this._particles=[],this._initializers=[],this._actions=[],this._activities=[],this._handlers=[],this.callbacks={}},SPARKS.Emitter.prototype={_TIMESTEP:15,_timer:null,_lastTime:null,_timerStep:10,_velocityVerlet:!0,start:function(){this._lastTime=Date.now(),this._timer=setTimeout(this.step,this._timerStep,this),this._isRunning=!0},stop:function(){this._isRunning=!1,clearTimeout(this._timer)},isRunning:function(){return this._isRunning&!0},step:function(e){var t=Date.now(),i=t-e._lastTime;if(this._velocityVerlet)e.update(i/1e3),e._lastTime=t;else{var r=20*e._TIMESTEP;for(i>=r&&(i=r);i>=e._TIMESTEP;)e.update(e._TIMESTEP/1e3),i-=e._TIMESTEP;e._lastTime=t-i}e._isRunning&&setTimeout(e.step,e._timerStep,e)},update:function(e){var t,i,r=this._counter.updateEmitter(this,e);for(t=0;r>t;t++)this.createParticle();for(r=this._activities.length,t=0;r>t;t++)this._activities[t].update(this,e);r=this._actions.length;var n,o,a=this._particles.length;for(i=0;r>i;i++)for(o=this._actions[i],t=0;a>t;++t)n=this._particles[t],o.update(this,n,e);for(t=a;t--;)n=this._particles[t],n.isDead?(this._particles.splice(t,1),this.dispatchEvent("dead",n),SPARKS.VectorPool.release(n.position),SPARKS.VectorPool.release(n.velocity)):this.dispatchEvent("updated",n);this.dispatchEvent("loopUpdated")},createParticle:function(){var e,t=new SPARKS.Particle,i=this._initializers.length;for(e=0;i>e;e++)this._initializers[e].initialize(this,t);return this._particles.push(t),this.dispatchEvent("created",t),t},addInitializer:function(e){this._initializers.push(e)},addAction:function(e){this._actions.push(e)},removeInitializer:function(e){var t=this._initializers.indexOf(e);t>-1&&this._initializers.splice(t,1)},removeAction:function(e){var t=this._actions.indexOf(e);t>-1&&this._actions.splice(t,1)},addCallback:function(e,t){this.callbacks[e]=t},dispatchEvent:function(e,t){var i=this.callbacks[e];i&&i(t)}},SPARKS.EVENT_PARTICLE_CREATED="created",SPARKS.EVENT_PARTICLE_UPDATED="updated",SPARKS.EVENT_PARTICLE_DEAD="dead",SPARKS.EVENT_LOOP_UPDATED="loopUpdated",SPARKS.SteadyCounter=function(e){this.rate=e,this.leftover=0},SPARKS.SteadyCounter.prototype.updateEmitter=function(e,t){var i=t*this.rate+this.leftover,r=Math.floor(i);return this.leftover=i-r,r},SPARKS.ShotCounter=function(e){this.particles=e,this.used=!1},SPARKS.ShotCounter.prototype.updateEmitter=function(){return this.used?0:(this.used=!0,this.particles)},SPARKS.Particle=function(){this.lifetime=0,this.age=0,this.energy=1,this.isDead=!1,this.target=null,this.position=SPARKS.VectorPool.get().set(0,0,0),this.velocity=SPARKS.VectorPool.get().set(0,0,0),this._oldvelocity=SPARKS.VectorPool.get().set(0,0,0)},SPARKS.Action=function(){this._priority=0},SPARKS.Age=function(e){this._easing=null==e?TWEEN.Easing.Linear.None:e},SPARKS.Age.prototype.update=function(e,t,i){if(t.age+=i,t.age>=t.lifetime)t.energy=0,t.isDead=!0;else{var r=this._easing(t.age/t.lifetime);t.energy=-1*r+1}},SPARKS.Move=function(){},SPARKS.Move.prototype.update=function(e,t,i){var r=t.position,n=t.velocity,o=t._oldvelocity;this._velocityVerlet?(r.x+=.5*(n.x+o.x)*i,r.y+=.5*(n.y+o.y)*i,r.z+=.5*(n.z+o.z)*i):(r.x+=n.x*i,r.y+=n.y*i,r.z+=n.z*i)},SPARKS.DeathZone=function(e){this.zone=e},SPARKS.DeathZone.prototype.update=function(e,t){this.zone.contains(t.position)&&(t.isDead=!0)},SPARKS.ActionZone=function(e,t){this.action=e,this.zone=t},SPARKS.ActionZone.prototype.update=function(e,t,i){this.zone.contains(t.position)&&this.action.update(e,t,i)},SPARKS.Accelerate=function(e,t,i){return e instanceof THREE.Vector3?(this.acceleration=e,void 0):(this.acceleration=new THREE.Vector3(e,t,i),void 0)},SPARKS.Accelerate.prototype.update=function(e,t,i){var r=this.acceleration,n=t.velocity;t._oldvelocity.set(n.x,n.y,n.z),n.x+=r.x*i,n.y+=r.y*i,n.z+=r.z*i},SPARKS.AccelerateFactor=function(e){this.factor=e},SPARKS.AccelerateFactor.prototype.update=function(e,t,i){var r,n=this.factor,o=t.velocity,a=o.length();a>0&&(r=n*i/a,r+=1,o.multiplyScalar(r))},SPARKS.AccelerateVelocity=function(e){this.factor=e},SPARKS.AccelerateVelocity.prototype.update=function(e,t){var i=this.factor,r=t.velocity;r.z+=-r.x*i,r.y+=r.z*i,r.x+=r.y*i},SPARKS.RandomDrift=function(e,t,i){return e instanceof THREE.Vector3?(this.drift=e,void 0):(this.drift=new THREE.Vector3(e,t,i),void 0)},SPARKS.RandomDrift.prototype.update=function(e,t,i){var r=this.drift,n=t.velocity;n.x+=(Math.random()-.5)*r.x*i,n.y+=(Math.random()-.5)*r.y*i,n.z+=(Math.random()-.5)*r.z*i},SPARKS.Zone=function(){},SPARKS.PointZone=function(e){this.pos=e},SPARKS.PointZone.prototype.getLocation=function(){return this.pos},SPARKS.PointZone=function(e){this.pos=e},SPARKS.PointZone.prototype.getLocation=function(){return this.pos},SPARKS.LineZone=function(e,t){this.start=e,this.end=t,this._length=t.clone().sub(e)},SPARKS.LineZone.prototype.getLocation=function(){var e=this._length.clone();return e.multiplyScalar(Math.random()),e.add(this.start)},SPARKS.ParallelogramZone=function(e,t,i){this.corner=e,this.side1=t,this.side2=i},SPARKS.ParallelogramZone.prototype.getLocation=function(){var e=this.side1.clone().multiplyScalar(Math.random()),t=this.side2.clone().multiplyScalar(Math.random());return e.add(t),e.add(this.corner)},SPARKS.CubeZone=function(e,t,i,r){this.position=e,this.x=t,this.y=i,this.z=r},SPARKS.CubeZone.prototype.getLocation=function(){var e=this.position.clone();return e.x+=Math.random()*this.x,e.y+=Math.random()*this.y,e.z+=Math.random()*this.z,e},SPARKS.CubeZone.prototype.contains=function(e){var t=this.position.x,i=this.position.y,r=this.position.z,n=this.x,o=this.y,a=this.z;0>n&&(t+=n,n=Math.abs(n)),0>o&&(i+=o,o=Math.abs(o)),0>a&&(r+=a,a=Math.abs(a));var s=e.x-t,l=e.y-i,h=e.z-r;return s>0&&n>s&&l>0&&o>l&&h>0&&a>h?!0:!1},SPARKS.SphereCapZone=function(e,t,i,r,n,o){this.x=e,this.y=t,this.z=i,this.minr=r,this.maxr=n,this.angle=o},SPARKS.SphereCapZone.prototype.getLocation=function(){var e=2*Math.PI*SPARKS.Utils.random(),t=SPARKS.Utils.random(),i=SPARKS.VectorPool.get().set(t*Math.cos(e),-1/Math.tan(this.angle*SPARKS.Utils.DEGREE_TO_RADIAN),t*Math.sin(e)),r=this.minr-(this.minr-this.maxr)*Math.random();return i.multiplyScalar(r),i.__markedForReleased=!0,i},SPARKS.Lifetime=function(e,t){this._min=e,this._max=t?t:e},SPARKS.Lifetime.prototype.initialize=function(e,t){t.lifetime=this._min+SPARKS.Utils.random()*(this._max-this._min)},SPARKS.Position=function(e){this.zone=e},SPARKS.Position.prototype.initialize=function(e,t){var i=this.zone.getLocation();t.position.set(i.x,i.y,i.z)},SPARKS.Velocity=function(e){this.zone=e},SPARKS.Velocity.prototype.initialize=function(e,t){var i=this.zone.getLocation();t.velocity.set(i.x,i.y,i.z),i.__markedForReleased&&(SPARKS.VectorPool.release(i),i.__markedForReleased=!1)},SPARKS.Target=function(e,t){this.target=e,this.callback=t},SPARKS.Target.prototype.initialize=function(e,t){t.target=this.callback?this.callback():this.target},SPARKS.VectorPool={__pools:[],get:function(){return this.__pools.length>0?this.__pools.pop():this._addToPool()},release:function(e){this.__pools.push(e)},_addToPool:function(){for(var e=0,t=100;t>e;e++)this.__pools.push(new THREE.Vector3);return new THREE.Vector3}},SPARKS.Utils={random:function(){return Math.random()},DEGREE_TO_RADIAN:Math.PI/180,TWOPI:2*Math.PI,getPerpendiculars:function(e){var t=this.getPerpendicular(e),i=e.cross(t);return i.normalize(),[t,i]},getPerpendicular:function(e){if(0==e.x)return new THREE.Vector3D(1,0,0);var t=new THREE.Vector3(e.y,-e.x,0);return t.normalize()}};