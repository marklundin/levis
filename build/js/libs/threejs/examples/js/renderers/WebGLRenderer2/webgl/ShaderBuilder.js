THREE.WebGLRenderer.ShaderBuilder=function(e,t){this.renderer=e,this.info=t,this.programs=[],this.programs_counter=0},THREE.extend(THREE.WebGLRenderer.ShaderBuilder.prototype,{buildProgram:function(e,t,i,r,n,o,a){var s,l,c,h,u,d=this.renderer,p=[];e?p.push(e):(p.push(t),p.push(i));for(c in o)p.push(c),p.push(o[c]);for(s in a)p.push(s),p.push(a[s]);for(u=p.join(),s=0,l=this.programs.length;l>s;s++){var f=this.programs[s];if(f.code===u)return f.usedTimes++,f.program}var m="SHADOWMAP_TYPE_BASIC";a.shadowMapType===THREE.PCFShadowMap?m="SHADOWMAP_TYPE_PCF":a.shadowMapType===THREE.PCFSoftShadowMap&&(m="SHADOWMAP_TYPE_PCF_SOFT");var g=this.generateDefines(o),v=["precision "+d.precision+" float;",g,d.supportsVertexTextures?"#define VERTEX_TEXTURES":"",a.gammaInput?"#define GAMMA_INPUT":"",a.gammaOutput?"#define GAMMA_OUTPUT":"",a.physicallyBasedShading?"#define PHYSICALLY_BASED_SHADING":"","#define MAX_DIR_LIGHTS "+a.maxDirLights,"#define MAX_POINT_LIGHTS "+a.maxPointLights,"#define MAX_SPOT_LIGHTS "+a.maxSpotLights,"#define MAX_HEMI_LIGHTS "+a.maxHemiLights,"#define MAX_SHADOWS "+a.maxShadows,"#define MAX_BONES "+a.maxBones,a.map?"#define USE_MAP":"",a.envMap?"#define USE_ENVMAP":"",a.lightMap?"#define USE_LIGHTMAP":"",a.bumpMap?"#define USE_BUMPMAP":"",a.normalMap?"#define USE_NORMALMAP":"",a.specularMap?"#define USE_SPECULARMAP":"",a.vertexColors?"#define USE_COLOR":"",a.skinning?"#define USE_SKINNING":"",a.useVertexTexture?"#define BONE_TEXTURE":"",a.boneTextureWidth?"#define N_BONE_PIXEL_X "+a.boneTextureWidth.toFixed(1):"",a.boneTextureHeight?"#define N_BONE_PIXEL_Y "+a.boneTextureHeight.toFixed(1):"",a.morphTargets?"#define USE_MORPHTARGETS":"",a.morphNormals?"#define USE_MORPHNORMALS":"",a.perPixel?"#define PHONG_PER_PIXEL":"",a.wrapAround?"#define WRAP_AROUND":"",a.doubleSided?"#define DOUBLE_SIDED":"",a.flipSided?"#define FLIP_SIDED":"",a.shadowMapEnabled?"#define USE_SHADOWMAP":"",a.shadowMapEnabled?"#define "+m:"",a.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",a.shadowMapCascade?"#define SHADOWMAP_CASCADE":"",a.sizeAttenuation?"#define USE_SIZEATTENUATION":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","attribute vec2 uv2;","#ifdef USE_COLOR","attribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","attribute vec3 morphTarget0;","attribute vec3 morphTarget1;","attribute vec3 morphTarget2;","attribute vec3 morphTarget3;","#ifdef USE_MORPHNORMALS","attribute vec3 morphNormal0;","attribute vec3 morphNormal1;","attribute vec3 morphNormal2;","attribute vec3 morphNormal3;","#else","attribute vec3 morphTarget4;","attribute vec3 morphTarget5;","attribute vec3 morphTarget6;","attribute vec3 morphTarget7;","#endif","#endif","#ifdef USE_SKINNING","attribute vec4 skinIndex;","attribute vec4 skinWeight;","#endif",""].join("\n"),E=["precision "+d.precision+" float;",a.bumpMap||a.normalMap?"#extension GL_OES_standard_derivatives : enable":"",g,"#define MAX_DIR_LIGHTS "+a.maxDirLights,"#define MAX_POINT_LIGHTS "+a.maxPointLights,"#define MAX_SPOT_LIGHTS "+a.maxSpotLights,"#define MAX_HEMI_LIGHTS "+a.maxHemiLights,"#define MAX_SHADOWS "+a.maxShadows,a.alphaTest?"#define ALPHATEST "+a.alphaTest:"",a.gammaInput?"#define GAMMA_INPUT":"",a.gammaOutput?"#define GAMMA_OUTPUT":"",a.physicallyBasedShading?"#define PHYSICALLY_BASED_SHADING":"",a.useFog&&a.fog?"#define USE_FOG":"",a.useFog&&a.fogExp?"#define FOG_EXP2":"",a.map?"#define USE_MAP":"",a.envMap?"#define USE_ENVMAP":"",a.lightMap?"#define USE_LIGHTMAP":"",a.bumpMap?"#define USE_BUMPMAP":"",a.normalMap?"#define USE_NORMALMAP":"",a.specularMap?"#define USE_SPECULARMAP":"",a.vertexColors?"#define USE_COLOR":"",a.metal?"#define METAL":"",a.perPixel?"#define PHONG_PER_PIXEL":"",a.wrapAround?"#define WRAP_AROUND":"",a.doubleSided?"#define DOUBLE_SIDED":"",a.flipSided?"#define FLIP_SIDED":"",a.shadowMapEnabled?"#define USE_SHADOWMAP":"",a.shadowMapEnabled?"#define "+m:"",a.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",a.shadowMapCascade?"#define SHADOWMAP_CASCADE":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;",""].join("\n");h=d.compileShader(v+i,E+t),h.uniforms={},h.attributes={};var y,T,_,b;y=["viewMatrix","modelViewMatrix","projectionMatrix","normalMatrix","modelMatrix","cameraPosition","morphTargetInfluences"],a.useVertexTexture?y.push("boneTexture"):y.push("boneGlobalMatrices");for(T in r)y.push(T);for(this.cacheUniformLocations(h,y),y=["position","normal","uv","uv2","tangent","color","skinIndex","skinWeight","lineDistance"],b=0;b<a.maxMorphTargets;b++)y.push("morphTarget"+b);for(b=0;b<a.maxMorphNormals;b++)y.push("morphNormal"+b);for(_ in n)y.push(_);return this.cacheAttributeLocations(h,y),h.id=this.programs_counter++,this.programs.push({program:h,code:u,usedTimes:1}),this.info.memory.programs=this.programs.length,h},generateDefines:function(e){var t,i,r=[];for(var n in e)t=e[n],t!==!1&&(i="#define "+n+" "+t,r.push(i));return r.join("\n")},cacheUniformLocations:function(e,t){var i,r,n,o=this.renderer;for(i=0,r=t.length;r>i;i++)n=t[i],e.uniforms[n]=o.getUniformLocation(e,n)},cacheAttributeLocations:function(e,t){var i,r,n,o=this.renderer;for(i=0,r=t.length;r>i;i++)n=t[i],e.attributes[n]=o.getAttribLocation(e,n)},removeProgram:function(e){var t,i,r,n=!1,o=this.programs;for(t=0,i=o.length;i>t;t++)if(r=o[t],r.program===e){r.usedTimes--,0===r.usedTimes&&(n=!0);break}if(n===!0){var a=[];for(t=0,i=o.length;i>t;t++)r=o[t],r.program!==e&&a.push(r);this.programs=a,this.renderer.deleteProgram(e),this.info.memory.programs--}}});